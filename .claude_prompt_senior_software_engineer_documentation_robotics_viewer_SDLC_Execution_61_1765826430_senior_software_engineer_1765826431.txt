
You are a Senior Software Engineer.

I implement clean, well thought out code with proper error handling and maintainable architecture.

**Issue Title**: Phase 6: E2E testing for graph rendering and sidebar fixes

**Description**:
Create comprehensive E2E tests verifying that React Flow graphs render correctly, only one sidebar appears in JSON views, the right sidebar remains attached to the screen edge, and all layout fixes work across all tabs. Include screenshot validation to prove graph rendering.

## Requirements
- US-8: E2E tests verify React Flow graphs are visible using in-browser validation
- US-8: E2E tests verify only one sidebar is present in JSON views
- US-8: E2E tests verify no third-level tabs exist in SpecViewer
- US-8: E2E tests include screenshot capture proving graphs render correctly
- All user stories must have corresponding E2E test coverage

## Design Guidance
**Test Files to Create/Modify**:

1. **Update `tests/embedded-app.spec.ts`**:
   - Add graph visibility assertions for Model and Spec tabs
   - Add single sidebar assertions for JSON views
   - Add right sidebar positioning tests

2. **Create `tests/embedded-graph-rendering.spec.ts`** (new file):
   - Dedicated tests for graph rendering across all tabs
   - Screenshot capture for visual proof
   - React Flow node visibility validation

**Test Case Examples**:

```typescript
// Graph rendering test
test('Model tab graph view renders React Flow nodes', async ({ page }) => {
  await page.goto('http://localhost:5174/model/graph');
  
  // Wait for React Flow to initialize
  await page.waitForSelector('.react-flow', { timeout: 10000 });
  
  // Verify nodes are visible
  const nodes = page.locator('.react-flow__node');
  await expect(nodes.first()).toBeVisible({ timeout: 5000 });
  
  // Count nodes to ensure graph loaded
  const nodeCount = await nodes.count();
  expect(nodeCount).toBeGreaterThan(0);
  
  // Screenshot for visual proof
  await page.screenshot({ 
    path: 'test-results/model-graph-rendering.png',
    fullPage: false 
  });
});

// Single sidebar test
test('Model JSON view has only one left sidebar', async ({ page }) => {
  await page.goto('http://localhost:5174/model/json');
  
  // Check for left sidebar (correct)
  const leftSidebar = page.locator('[data-testid="left-sidebar"]');
  await expect(leftSidebar).toBeVisible();
  await expect(leftSidebar).toHaveCount(1);
  
  // Ensure no internal SidebarList component
  const sidebarList = page.locator('.sidebar-list-component'); // Add data-testid if needed
  await expect(sidebarList).toHaveCount(0);
});

// Right sidebar positioning test
test('Right sidebar attached to screen edge in graph view', async ({ page }) => {
  await page.setViewportSize({ width: 1920, height: 1080 });
  await page.goto('http://localhost:5174/model/graph');
  
  const rightSidebar = page.locator('[data-testid="right-sidebar"]');
  await expect(rightSidebar).toBeVisible();
  
  const box = await rightSidebar.boundingBox();
  const viewport = page.viewportSize();
  
  // Right edge should be at viewport edge (within 2px tolerance)
  expect(Math.abs((box.x + box.width) - viewport.width)).toBeLessThan(2);
});

// SpecViewer third-level tabs removed
test('Spec JSON view has no third-level tabs', async ({ page }) => {
  await page.goto('http://localhost:5174/spec/json');
  
  // Select a schema to trigger content rendering
  await page.click('[data-testid="schema-selector"] button:first-child');
  
  // Verify no tabs for Schemas/Cross-Layer Links
  const thirdLevelTabs = page.locator('[role="tablist"]').nth(2); // Third tab level
  await expect(thirdLevelTabs).toHaveCount(0);
  
  // Verify both sections appear together
  await expect(page.locator('text=Schema Definitions')).toBeVisible();
  await expect(page.locator('text=Cross-Layer Links')).toBeVisible();
});

// Full graph rendering suite
test.describe('Graph rendering across all tabs', () => {
  const tabs = [
    { name: 'Model', path: '/model/graph' },
    { name: 'Spec', path: '/spec/graph' },
    { name: 'Motivation', path: '/motivation' },
    { name: 'Architecture', path: '/architecture' }
  ];
  
  for (const tab of tabs) {
    test(`${tab.name} tab graph renders correctly`, async ({ page }) => {
      await page.goto(`http://localhost:5174${tab.path}`);
      await page.waitForSelector('.react-flow', { timeout: 10000 });
      
      const nodes = page.locator('.react-flow__node');
      const nodeCount = await nodes.count();
      expect(nodeCount).toBeGreaterThan(0);
      
      await page.screenshot({ 
        path: `test-results/${tab.name.toLowerCase()}-graph.png`,
        fullPage: false 
      });
    });
  }
});

// Architecture full-width test
test('Architecture graph occupies full width between sidebars', async ({ page }) => {
  await page.setViewportSize({ width: 1920, height: 1080 });
  await page.goto('http://localhost:5174/architecture');
  
  const leftSidebar = page.locator('[data-testid="left-sidebar"]');
  const rightSidebar = page.locator('[data-testid="right-sidebar"]');
  const graphContainer = page.locator('.react-flow');
  
  const leftBox = await leftSidebar.boundingBox();
  const rightBox = await rightSidebar.boundingBox();
  const graphBox = await graphContainer.boundingBox();
  
  // Graph should span from left sidebar edge to right sidebar edge
  expect(graphBox.x).toBeGreaterThanOrEqual(leftBox.x + leftBox.width);
  expect(graphBox.x + graphBox.width).toBeLessThanOrEqual(rightBox.x);
});
```

**Test Data Requirements**:
- Tests assume sample model loaded from `documentation-robotics/` directory
- Graph views should have >0 nodes to validate rendering
- Screenshots saved to `test-results/` directory for visual verification

**Test Execution**:
```bash
# Run all E2E tests
npx playwright test

# Run only graph rendering tests
npx playwright test embedded-graph-rendering

# Run with headed browser for debugging
npx playwright test --headed

# Generate HTML report
npx playwright show-report
```

## Acceptance Criteria
- [ ] All graph views (Model, Spec, Motivation, Architecture) have E2E tests verifying React Flow node visibility
- [ ] All JSON views have E2E tests verifying single sidebar presence
- [ ] Right sidebar positioning test passes for all graph views
- [ ] SpecViewer test verifies no third-level tabs exist
- [ ] SpecViewer test verifies merged schema/links content
- [ ] Screenshot tests capture visual proof of graph rendering
- [ ] All tests pass consistently (3 consecutive runs without flakiness)
- [ ] Test coverage includes dark mode verification (visual screenshots)
- [ ] HTML test report generated and reviewed
- [ ] Code is reviewed and approved

## Dependencies
Phase 1, Phase 3, Phase 4, Phase 5

## Parent Issue
Part of #54

## Discussion
This work is detailed in discussion [55](https://github.com/tinkermonkey/documentation_robotics_viewer/discussions/55)

---


## Previous Work and Feedback

The following is the complete history of agent outputs and feedback for this issue.
This includes outputs from ALL previous stages (design, testing, QA, etc.) and any
user feedback. If this issue was returned from testing or QA, pay special attention
to their feedback and address all issues they identified.

## Output from Software Architect

**@tinkermonkey** (human feedback):
# Architecture Design

---

Now I have a comprehensive understanding of the architecture. Let me synthesize this into the analysis.

## System Architecture

### Current State Analysis

The embedded app uses a 3-column layout architecture with the following component hierarchy:

```
EmbeddedLayout (header + main tabs)
â””â”€â”€ Routes (ModelRoute, SpecRoute, MotivationRoute, ArchitectureRoute)
    â””â”€â”€ SharedLayout (3-column wrapper)
        â”œâ”€â”€ Left Sidebar (w-64, via leftSidebarContent prop)
        â”œâ”€â”€ Main Content (flex-1, via children)
        â””â”€â”€ Right Sidebar (w-80, via rightSidebarContent prop)
```

### Identified Architecture Problems

**1. Dual Sidebar Rendering (JSON Views)**

The `SidebarList` component (`src/apps/embedded/components/common/SidebarList.tsx:32`) is a Flowbite `Sidebar` wrapper (w-80) used internally by `ModelJSONViewer` and `SpecViewer`. These components call `renderLayerList()` / `renderSchemaList()` which render `SidebarList` inside the main content area, creating a duplicate sidebar appearance alongside `SharedLayout`'s `leftSidebarContent`.

```
ModelRoute (SharedLayout)
â”œâ”€â”€ Left Sidebar (ModelLayersSidebar) â† Correct
â”œâ”€â”€ Main Content
â”‚   â””â”€â”€ ModelJSONViewer
â”‚       â””â”€â”€ SidebarList (w-80) â† PROBLEM: Internal sidebar
â””â”€â”€ Right Sidebar â† Correct
```

**2. Graph Container Height Collapse**

The height inheritance chain has a critical gap:

```
EmbeddedLayout: h-[calc(100vh-180px)] â† Fixed
â””â”€â”€ SharedLayout: h-full â† Inherits
    â””â”€â”€ main: flex-1 overflow-y-auto â† Missing min-h-0
        â””â”€â”€ Route: flex flex-col h-full â† Inherits
            â””â”€â”€ GraphViewer: .graph-viewer { height: 100% } â† Collapses
```

React Flow requires explicit height constraints. The `main` element has `overflow-y-auto` without `min-h-0`, causing flexbox children to overflow rather than constrain, and the graph container collapses to 0 height.

**3. Right Sidebar Detachment**

When main content collapses (graph not rendering), the right sidebar position depends on the flexbox content width. Without explicit `min-w-0` on the main content or absolute positioning for the right sidebar, it shifts inward.

**4. Third-Level Tabs in SpecViewer**

`SpecViewer.tsx:305-318` renders an internal tab bar with "Schemas" and "Cross-Layer Links" buttons, creating excessive UI nesting.

**5. Card Overuse**

Both `ModelJSONViewer` and `SpecViewer` wrap multiple levels in Flowbite `Card` components:
- Layer details in Card (line 290-298)
- Element types in nested Cards (line 323)
- Type definitions in nested Cards (line 337)

## Scalability Design

### Layout System Constraints

The layout architecture scales to arbitrary content sizes through:
- Fixed sidebar widths (w-64, w-80) provide predictable space allocation
- `flex-1` main content expands to available space
- `overflow-y-auto` handles content overflow

### Performance Considerations

React Flow graphs with >500 nodes use:
- Viewport culling (only render visible nodes)
- Web Workers for layout calculation (`/public/workers/layoutWorker.js`)
- Async layout with loading states

The layout fixes must preserve these patterns.

## Established Patterns

### SharedLayout Pattern (Correct)
Routes should pass all sidebar content via props, never render sidebars internally:
```typescript
<SharedLayout
  showLeftSidebar={true}
  leftSidebarContent={<LayerSelector />}
  rightSidebarContent={<AnnotationPanel />}
>
  <GraphOrJSONContent />
</SharedLayout>
```

### Graph Component Pattern
`MotivationGraphView` and `C4GraphView` demonstrate the correct pattern:
- Use `className="graph-viewer"` for React Flow container
- Apply `.graph-viewer { width: 100%; height: 100%; position: relative; }`
- Include internal filter/control panels as separate flexbox children

### Sidebar Pattern (ModelLayersSidebar - Correct)
Simple Tailwind-only implementation without Flowbite Sidebar wrapper:
- `div.p-4` container
- Button list with selection state
- Layer color indicators and counts

## Component Reuse

### Components to Remove
- `SidebarList` (`src/apps/embedded/components/common/SidebarList.tsx`) - Replace with Tailwind-only list pattern from `ModelLayersSidebar`

### Components to Modify

| Component | Change |
|-----------|--------|
| `SharedLayout` | Add `min-h-0` to main, `min-w-0` to children |
| `ModelJSONViewer` | Remove internal `SidebarList`, receive `selectedLayer` from parent |
| `SpecViewer` | Remove internal tabs, merge schemas+links, remove internal `SidebarList` |
| `GraphViewer` | Verify CSS height chain |
| Route components | Lift layer selection state, pass to both sidebar and content |

### Components to Preserve
- `ModelLayersSidebar` - Already follows correct pattern
- `AnnotationPanel`, `SchemaInfoPanel` - Right sidebar content
- `GraphViewer`, `MotivationGraphView`, `C4GraphView` - Core graph components

## Implementation Plan

### Phase 1: Fix Layout Height Chain

1. **Update `SharedLayout.tsx`**:
   - Add `min-h-0` to root flex container
   - Add `min-h-0` to main content element
   - Add `flex-shrink-0` to sidebar elements

2. **Update `EmbeddedLayout.tsx`**:
   - Ensure content div passes `h-full` to child routes

3. **Verify `GraphViewer.css`**:
   - Confirm `.graph-viewer` has `height: 100%` and `position: relative`

### Phase 2: Unify Sidebar Architecture

4. **Create lifted state pattern**:
   - Add `selectedLayerId` to route-level state (or Zustand store)
   - Pass selection handler to `ModelLayersSidebar`
   - Pass selected layer to JSON viewer components

5. **Modify `ModelJSONViewer`**:
   - Remove `renderLayerList()` method
   - Accept `selectedLayer: string | null` as prop
   - Remove internal `SidebarList` usage
   - Render only layer details content

6. **Modify `SpecViewer`**:
   - Remove third-level tabs (Schemas/Cross-Layer Links)
   - Merge `renderSchemaDetails()` to include cross-layer links section
   - Remove `renderSchemaList()` / `renderCategoryList()`
   - Accept `selectedSchema: string | null` as prop

7. **Update routes**:
   - `ModelRoute`: Lift `selectedLayer` state, pass to sidebar and `ModelJSONViewer`
   - `SpecRoute`: Lift `selectedSchema` state, pass to sidebar and `SpecViewer`

### Phase 3: Reduce Card Usage

8. **Simplify `SpecViewer` styling**:
   - Replace nested Cards with bordered sections
   - Use `border border-gray-200 rounded-lg` for container
   - Use `border-b` for section dividers
   - Maintain visual hierarchy through spacing and typography

9. **Simplify `ModelJSONViewer` styling**:
   - Remove Card wrapper from element type lists
   - Use `ExpandableSection` without Card wrapper
   - Apply `border-b` dividers between elements

### Phase 4: Fix Graph Views

10. **Fix `GraphViewer` rendering**:
    - Ensure ReactFlowProvider wraps component in routes that use it
    - Verify height inheritance through component chain

11. **Apply consistent pattern to all graph routes**:
    - `ModelRoute` graph view
    - `SpecRoute` graph view (via `SpecGraphView`)
    - `MotivationRoute` (already correct)
    - `ArchitectureRoute` (already correct)

### Phase 5: Cleanup

12. **Remove `SidebarList` component**:
    - Delete `src/apps/embedded/components/common/SidebarList.tsx`
    - Update any remaining imports to error

### Phase 6: E2E Testing

13. **Update existing tests**:
    - `tests/embedded-app.spec.ts`: Add graph visibility assertions
    - `tests/embedded-dual-view.spec.ts`: Add single sidebar assertions

14. **Add new test cases**:
    ```typescript
    test('graph view renders React Flow nodes', async ({ page }) => {
      await page.goto('/model/graph');
      await page.waitForSelector('.react-flow');
      const nodes = page.locator('.react-flow__node');
      await expect(nodes.first()).toBeVisible();
    });

    test('JSON view has single left sidebar', async ({ page }) => {
      await page.goto('/model/json');
      const sidebars = page.locator('[data-testid="left-sidebar"]');
      await expect(sidebars).toHaveCount(1);
    });

    test('right sidebar attached to screen edge', async ({ page }) => {
      await page.goto('/model/graph');
      const rightSidebar = page.locator('[data-testid="right-sidebar"]');
      const box = await rightSidebar.boundingBox();
      const viewport = page.viewportSize();
      // Right edge should be at viewport edge (within 1px tolerance)
      expect(Math.abs((box.x + box.width) - viewport.width)).toBeLessThan(2);
    });
    ```

15. **Screenshot validation**:
    - Capture reference screenshots matching `design.png` layout
    - Add visual regression tests for graph/JSON views

### ADR: Sidebar State Management

**Context**: JSON viewers currently manage their own layer selection state internally via `SidebarList`. This creates duplicate sidebars when combined with `SharedLayout`.

**Decision**: Lift layer selection state to route components and pass to both sidebar and content components via props.

**Alternatives Considered**:
1. **Zustand store for selection state**: Would work but adds complexity for route-local state
2. **URL-based selection**: `/model/json/business` - Clean but requires router changes
3. **Props drilling (chosen)**: Simple, explicit, works with current architecture

**Consequences**:
- Route components become slightly more complex
- Clear data flow from route â†’ sidebar and route â†’ content
- Easier to add cross-view selection persistence later

---
_Generated by Orchestrator Bot ðŸ¤–_
_Processed by the software_architect agent_

IMPORTANT: Review all feedback carefully and address every issue that is not already addressed.



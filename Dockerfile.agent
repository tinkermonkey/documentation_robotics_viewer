# ============================================================================
# Stage 1: Base Environment Setup
# ============================================================================
FROM clauditoreum-orchestrator:latest

# The base image already includes:
# - Claude CLI (REQUIRED - must be present)
# - Git CLI (REQUIRED - must be present)
# - GitHub CLI (REQUIRED - must be present)
# - Python 3.11
# - Essential build tools
# - procps package (provides 'ps' command needed by Claude CLI)

USER root

# ============================================================================
# Stage 2: Install Project-Specific Runtimes
# ============================================================================
# Install Node.js 20.x for this JavaScript/React project
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ============================================================================
# Stage 3: Pre-install Dependencies (OPTIONAL but RECOMMENDED)
# ============================================================================
# Pre-installing dependencies speeds up agent startup time because the agent
# doesn't have to install them every time it runs.

# WORKDIR should match where the orchestrator will mount the project
WORKDIR /workspace/documentation_robotics_viewer

# Copy ONLY the dependency manifests needed for installation
# DO NOT copy source code - it comes from the runtime mount
COPY package.json package-lock.json ./

# Pre-install npm dependencies
RUN --mount=type=cache,target=/root/.npm \
    npm ci --ignore-scripts && \
    npm cache clean --force

# Set Playwright to use a shared cache location accessible to orchestrator user
ENV PLAYWRIGHT_BROWSERS_PATH=/opt/ms-playwright

# Install Playwright browsers and system dependencies
# Note: Playwright requires specific system libraries for browser automation
RUN npx playwright install --with-deps chromium && \
    chown -R orchestrator:orchestrator /opt/ms-playwright

# ============================================================================
# Stage 4: Ownership and Permissions
# ============================================================================
# Change ownership ONLY of what was installed, NOT source code
# Source code ownership is handled by the mount
RUN chown -R orchestrator:orchestrator /workspace/documentation_robotics_viewer/node_modules

# ============================================================================
# Stage 5: Switch to Runtime User
# ============================================================================
USER orchestrator

# ============================================================================
# Stage 6: Verification (MANDATORY)
# ============================================================================
# Verify all critical CLIs are present (from base image)
RUN claude --version && \
    git --version && \
    gh --version

# Verify project-specific tools (Node.js)
RUN node --version && npm --version

# Verify Playwright installation
RUN npx playwright --version

# ============================================================================
# Default command
# ============================================================================
CMD ["/bin/bash"]

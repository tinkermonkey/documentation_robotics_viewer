
You are a Senior Software Engineer.

I implement clean, well thought out code with proper error handling and maintainable architecture.

**Issue Title**: [PR Review] Critical issues from PR Code Review

**Description**:
## Critical Findings

**Source**: PR Code Review

- **Missing error handling for annotation loading**: `/workspace/src/apps/embedded/routes/ModelRoute.tsx:133-134` - The annotation loading inside `onSuccess` has NO error handling at all. If `loadAnnotations()` throws, the entire callback fails silently, and spec data loading is never attempted.
- **Missing WebSocket server-side disconnection recovery test**: `/workspace/tests/websocket-recovery.spec.ts` - The test description claims to test "WebSocket connection recovers after server-side disconnection" but there is no actual test that simulates a server-side close event. The reconnect logic in `websocketClient.ts:369-396` is untested.
- **Missing max reconnect attempts exhaustion test**: `/workspace/tests/websocket-recovery.spec.ts` - The `websocketClient.ts` has `maxReconnectAttempts = 10` and emits `max-reconnect-attempts` event, but this behavior is not tested. Users could be stuck disconnected without notification.

---
_Created by PR Review Stage_


## Previous Work and Feedback

The following is the complete history of agent outputs and feedback for this issue.
This includes outputs from ALL previous stages (design, testing, QA, etc.) and any
user feedback. If this issue was returned from testing or QA, pay special attention
to their feedback and address all issues they identified.

## Output from Software Architect

**software_architect** (agent):
# Architecture Design

---

## Executive Summary

This issue requires migrating the Documentation Robotics Viewer from using a local Python reference server to the official DR CLI API. The changes involve:

1. Adding an npm script to sync the API spec from the upstream repository
2. Updating the frontend to align with the current DR CLI API specification  
3. Removing the local Python reference server entirely
4. Updating development/test workflows to use the DR CLI server directly

## Current State Analysis

### Local Reference Server
The project currently maintains a local Python reference server (`reference_server/`) that:
- Serves as a development mock for the DR CLI visualization server
- Implements endpoints: `/health`, `/api/spec`, `/api/model`, `/api/link-registry`, `/api/changesets`, `/api/annotations`, `/ws`
- Includes WebSocket support with JSON-RPC 2.0 for chat integration
- Contains mock data in `reference_server/mock_data/`
- Total Python files: `main.py`, `chat_handler.py`, `message_router.py`, `setup_mock_data.py`

### API Spec Alignment
The project has a local API spec at `/workspace/docs/api-spec.yaml` dated 2026-02-07. Comparing with the upstream spec:

**Current Local Spec Features:**
- All standard endpoints: `/health`, `/api/spec`, `/api/model`, `/api/layers/{layerName}`, `/api/elements/{elementId}`, `/api/changesets`, `/api/annotations`
- `/api/link-registry` endpoint for cross-layer link definitions
- WebSocket at `/ws` with legacy protocol and JSON-RPC 2.0 chat
- Authentication: Bearer token, query parameter, WebSocket protocol header

**Upstream Compatibility:** The local spec appears to be current with the upstream DR CLI spec. However, the spec should be synchronized automatically rather than manually copied.

### Frontend API Integration
Key service files consuming the API:
- `src/apps/embedded/services/embeddedDataLoader.ts` - REST API client (fully implements current spec)
- `src/apps/embedded/services/websocketClient.ts` - WebSocket client with auth, reconnection
- `src/apps/embedded/services/chatService.ts` - JSON-RPC chat integration
- `src/apps/embedded/services/jsonRpcHandler.ts` - JSON-RPC message handling

### Server Dependencies
Files referencing the reference server (port 8765):
- `vite.config.embedded.ts` - Dev server proxy configuration
- `playwright.e2e.config.ts` - E2E test server startup
- `playwright.auth.config.ts` - Auth test configuration
- `tests/global-setup.ts` - Test environment initialization
- `scripts/start-servers.sh` - Development convenience script
- Multiple E2E test files

## System Architecture

### Target Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Documentation Robotics Viewer            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Vite Dev   â”‚â”€â”€â”€â–¶â”‚   Proxy to   â”‚â”€â”€â”€â–¶â”‚  DR CLI      â”‚   â”‚
â”‚  â”‚   Server     â”‚    â”‚   DR CLI     â”‚    â”‚  Server      â”‚   â”‚
â”‚  â”‚   (3001)     â”‚    â”‚   (8080*)    â”‚    â”‚  (external)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  npm run sync-api-spec                               â”‚   â”‚
â”‚  â”‚  - Fetches latest api-spec.yaml from upstream        â”‚   â”‚
â”‚  â”‚  - Validates spec against local TypeScript types     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* DR CLI default port is 8080, configurable via --port
```

### API Spec Sync Mechanism
```
GitHub Repository (upstream)
docs/api-spec.yaml
        â”‚
        â–¼ npm run sync:api-spec
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetch via curl    â”‚
â”‚  or gh raw API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
/workspace/docs/api-spec.yaml
        â”‚
        â–¼
(Optional) TypeScript type validation
```

## Implementation Plan

### Phase 1: Add API Spec Sync Script

**Files to create:**
- `scripts/sync-api-spec.sh` or `scripts/sync-api-spec.cjs`

**npm script to add:**
```json
{
  "scripts": {
    "sync:api-spec": "bash scripts/sync-api-spec.sh"
  }
}
```

**Script functionality:**
- Download `api-spec.yaml` from `https://raw.githubusercontent.com/tinkermonkey/documentation_robotics/main/docs/api-spec.yaml`
- Save to `/workspace/docs/api-spec.yaml`
- Optionally validate against existing TypeScript types

### Phase 2: Update Vite Proxy Configuration

**File: `vite.config.embedded.ts`**

Change proxy target from `localhost:8765` (reference server) to configurable DR CLI server URL:
- Default to `localhost:8080` (DR CLI default)
- Support `DR_API_URL` environment variable for flexibility

```typescript
server: {
  proxy: {
    '/api': {
      target: process.env.DR_API_URL || 'http://localhost:8080',
      changeOrigin: true
    },
    '/health': {
      target: process.env.DR_API_URL || 'http://localhost:8080',
      changeOrigin: true
    },
    '/ws': {
      target: process.env.DR_WS_URL || 'ws://localhost:8080',
      ws: true
    }
  }
}
```

### Phase 3: Update Test Configuration

**Files to modify:**
- `playwright.e2e.config.ts` - Remove reference server startup
- `playwright.auth.config.ts` - Update server URL
- `tests/global-setup.ts` - Update health check URL

**Testing approach:**
- E2E tests will require a running DR CLI server (`dr visualize`)
- Add clear documentation for test prerequisites
- Consider adding a CI integration step that installs DR CLI

### Phase 4: Remove Reference Server

**Files/directories to delete:**
- `reference_server/` directory (main.py, chat_handler.py, message_router.py, setup_mock_data.py, requirements.txt, README.md, mock_data/)
- References in `scripts/start-servers.sh`
- References in `.gitignore` if any

### Phase 5: Documentation Updates

**Files to update:**
- `README.md` - Update development instructions
- `tests/README.md` - Update test prerequisites
- `CLAUDE.md` - Update if necessary

## Component Reuse

### Existing Components (No Changes Required)
- `embeddedDataLoader.ts` - Already implements full API spec
- `websocketClient.ts` - Already supports DR CLI authentication patterns
- `chatService.ts` - Already implements JSON-RPC 2.0 protocol
- All TypeScript types in `src/apps/embedded/services/` - Already match API spec

### Configuration Changes Only
- `vite.config.embedded.ts` - Proxy target URL
- Playwright config files - Server URLs and startup commands

## Established Patterns

### Port Configuration Pattern
The codebase uses environment variables for configuration:
- Use `DR_API_URL` for API server URL
- Use `DR_WS_URL` for WebSocket URL
- Default to DR CLI defaults (port 8080)

### npm Script Pattern
Follow existing patterns in `package.json`:
```json
"sync:api-spec": "bash scripts/sync-api-spec.sh"
```

### Test Environment Pattern
Tests rely on `playwright.e2e.config.ts` webServer configuration - this pattern remains but points to external server.

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| DR CLI not installed locally | E2E tests fail | Clear documentation, skip tests if server unavailable |
| API spec drift | Type mismatches | Regular sync script runs, CI validation |
| Port conflicts | Development issues | Configurable port via environment variable |
| Loss of mock data | Testing limitations | DR CLI includes sample model, use real data |

## Dependencies

### External Dependencies
- DR CLI must be installed for:
  - Local development (`dr visualize`)
  - E2E testing
  
### Version Requirements
- DR CLI version providing `api-spec.yaml` at documented location
- API spec version compatibility with TypeScript types

## Migration Checklist

1. [ ] Create `scripts/sync-api-spec.sh` script
2. [ ] Add `sync:api-spec` npm script
3. [ ] Run initial API spec sync and verify
4. [ ] Update `vite.config.embedded.ts` proxy configuration
5. [ ] Update `playwright.e2e.config.ts` to remove reference server startup
6. [ ] Update `playwright.auth.config.ts` server configuration
7. [ ] Update `tests/global-setup.ts` URLs
8. [ ] Update `scripts/start-servers.sh` to only start Vite
9. [ ] Delete `reference_server/` directory
10. [ ] Update `README.md` with new development instructions
11. [ ] Update `tests/README.md` with DR CLI prerequisites
12. [ ] Verify all E2E tests pass with DR CLI server
13. [ ] Clean up any remaining port 8765 references

---
_Generated by Orchestrator Bot ğŸ¤–_
_Processed by the software_architect agent_

IMPORTANT: Review all feedback carefully and address every issue that is not already addressed.



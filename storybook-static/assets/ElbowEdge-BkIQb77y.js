import{r as $,j as m}from"./iframe-DSSgKmXl.js";import{b as pe,c as ve,d as Ee,B as ue,E as G}from"./index-DzsatpJz.js";import{u as ke}from"./useNavigate-CEEZa2t9.js";import{a as Me,g as $e}from"./layerColors-Dv3sYeJV.js";import{u as ye}from"./crossLayerStore-Bec5Tsd5.js";function X(e,t,r){const n={x:r.x-10,y:r.y-10,width:r.width+20,height:r.height+20};return e.x<n.x&&t.x<n.x||e.x>n.x+n.width&&t.x>n.x+n.width||e.y<n.y&&t.y<n.y||e.y>n.y+n.height&&t.y>n.y+n.height?!1:he(e,n)||he(t,n)?!0:z(e,t,{x:n.x,y:n.y},{x:n.x+n.width,y:n.y})||z(e,t,{x:n.x+n.width,y:n.y},{x:n.x+n.width,y:n.y+n.height})||z(e,t,{x:n.x+n.width,y:n.y+n.height},{x:n.x,y:n.y+n.height})||z(e,t,{x:n.x,y:n.y+n.height},{x:n.x,y:n.y})}function he(e,t){return e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height}function z(e,t,r,i){const n=(t.x-e.x)*(i.y-r.y)-(i.x-r.x)*(t.y-e.y);if(n===0)return!1;const s=((i.y-r.y)*(i.x-e.x)+(r.x-i.x)*(i.y-e.y))/n,l=((e.y-t.y)*(i.x-e.x)+(t.x-e.x)*(i.y-e.y))/n;return s>0&&s<1&&l>0&&l<1}function K(e){return`${Math.round(e.x)},${Math.round(e.y)}`}function de(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function Le(e,t,r,i,n){const l=new Set,u=new Set;l.add(Math.round(e.x)),u.add(Math.round(e.y)),l.add(Math.round(t.x)),u.add(Math.round(t.y));const d=[...r];i&&d.push(i),n&&d.push(n);for(const c of d)l.add(Math.round(c.x-20)),l.add(Math.round(c.x+c.width+20)),u.add(Math.round(c.y-20)),u.add(Math.round(c.y+c.height+20));const g=[];for(const c of l)for(const p of u)g.push({x:c,y:p});return g}function je(e){const t=new Map,r=new Map;for(const n of e)t.has(n.x)||t.set(n.x,[]),t.get(n.x).push(n),r.has(n.y)||r.set(n.y,[]),r.get(n.y).push(n);const i=new Map;for(const n of e){const s=[];for(const l of t.get(n.x)??[])l.y!==n.y&&s.push(l);for(const l of r.get(n.y)??[])l.x!==n.x&&s.push(l);i.set(K(n),s)}return i}function Ne(e,t,r,i,n,s){const l=K(e),u=K(t),d=je(r),g=new Map,c=new Set;g.set(l,{point:e,g:0,f:de(e,t),parent:null,direction:null});let p=0;const h=2e3;for(;g.size>0&&p++<h;){let y="",x=null,v=1/0;for(const[E,w]of g)w.f<v&&(v=w.f,y=E,x=w);if(!x)break;if(y===u){const E=[];let w=x;for(;w;)E.unshift(w.point),w=w.parent;return E}g.delete(y),c.add(y);const o=d.get(y)??[];for(const E of o){const w=K(E);if(c.has(w))continue;const N=E.x-x.point.x,C=E.y-x.point.y,R=N!==0?"horizontal":"vertical";let A=!1;for(const T of i)if(X(x.point,E,T)){A=!0;break}if(A)continue;const Y=y===l,S=w===u;if(!Y&&n&&X(x.point,E,n)||!S&&s&&X(x.point,E,s))continue;const F=x.direction!==null&&x.direction!==R?100:0,j=x.g+Math.abs(N)+Math.abs(C)+F,D=g.get(w);(!D||j<D.g)&&g.set(w,{point:E,g:j,f:j+de(E,t),parent:x,direction:R})}}return null}function Ce(e){if(e.length<=2)return e;const t=[e[0]];for(let r=1;r<e.length-1;r++){const i=t[t.length-1],n=e[r],s=e[r+1];Math.abs(i.x-n.x)<.1&&Math.abs(n.x-s.x)<.1||Math.abs(i.y-n.y)<.1&&Math.abs(n.y-s.y)<.1||t.push(n)}return t.push(e[e.length-1]),t}function xe(e,t,r,i){if(r==="left"||r==="right"){const s=e.x+(t.x-e.x)*i;return[e,{x:s,y:e.y},{x:s,y:t.y},t]}else{const s=e.y+(t.y-e.y)*i;return[e,{x:e.x,y:s},{x:t.x,y:s},t]}}function ge(e,t){for(let r=0;r<e.length-1;r++)for(const i of t)if(X(e[r],e[r+1],i))return!0;return!1}function De(e,t,r,i){const n=[.5,.3,.7,.2,.8,.1,.9];for(const s of n){const l=xe(e,t,i,s);if(!ge(l,r))return l}return null}function Se(e,t,r,i,n){const s=i==="left"||i==="right",l=20,u=s?Math.min(e.y,t.y)-200:Math.min(e.x,t.x)-200,d=s?Math.max(e.y,t.y)+200:Math.max(e.x,t.x)+200,g=20,c=(u+d)/2,p=[];for(let h=u;h<=d;h+=g)p.push(h);p.sort((h,y)=>Math.abs(h-c)-Math.abs(y-c));for(const h of p){let y;if(s){const x=i==="right"?1:-1,v=n==="right"?-1:1;y=[e,{x:e.x+x*l,y:e.y},{x:e.x+x*l,y:h},{x:t.x+v*l,y:h},{x:t.x+v*l,y:t.y},t]}else{const x=i==="bottom"?1:-1,v=n==="bottom"?-1:1;y=[e,{x:e.x,y:e.y+x*l},{x:h,y:e.y+x*l},{x:h,y:t.y+v*l},{x:t.x,y:t.y+v*l},t]}if(!ge(y,r))return y}return null}function Te(e){const{sourceX:t,sourceY:r,targetX:i,targetY:n,sourcePosition:s,targetPosition:l,obstacles:u,sourceRect:d,targetRect:g}=e,c={x:Math.round(t),y:Math.round(r)},p={x:Math.round(i),y:Math.round(n)},h=De(c,p,u,s);if(h)return h;const y=Se(c,p,u,s,l);if(y)return y;const x=Le(c,p,u,d,g),v=Ne(c,p,x,u,d,g);return v?Ce(v):xe(c,p,s,.5)}function Ie(e,t=8){if(e.length<2)return"";let r=`M ${e[0].x},${e[0].y}`;for(let i=1;i<e.length-1;i++){const n=e[i-1],s=e[i],l=e[i+1],u=s.x-n.x,d=s.y-n.y,g=l.x-s.x,c=l.y-s.y,p=Math.sqrt(u*u+d*d),h=Math.sqrt(g*g+c*c);if(p<.01||h<.01){r+=` L ${s.x},${s.y}`;continue}const y=Math.min(t,p/2,h/2),x={x:s.x-u/p*y,y:s.y-d/p*y},v={x:s.x+g/h*y,y:s.y+c/h*y};r+=` L ${x.x},${x.y}`,r+=` Q ${s.x},${s.y} ${v.x},${v.y}`}return r+=` L ${e[e.length-1].x},${e[e.length-1].y}`,r}const O=$.memo(({edgeId:e,index:t,x:r,y:i,onMove:n,onRemove:s})=>{const{screenToFlowPosition:l}=pe(),u=$.useCallback(c=>{c.stopPropagation();const p=y=>{const x=l({x:y.clientX,y:y.clientY});n(t,x)},h=()=>{document.removeEventListener("pointermove",p),document.removeEventListener("pointerup",h)};document.addEventListener("pointermove",p),document.addEventListener("pointerup",h)},[t,n,l]),d=$.useCallback(c=>{c.stopPropagation(),s(t)},[t,s]),g=$.useCallback(c=>{let h=0,y=0;if(c.key==="ArrowLeft")h=-10;else if(c.key==="ArrowRight")h=10;else if(c.key==="ArrowUp")y=-10;else if(c.key==="ArrowDown")y=10;else if(c.key==="Delete"||c.key==="Backspace"){c.preventDefault(),s(t);return}else return;c.preventDefault(),n(t,{x:r+h,y:i+y})},[t,r,i,n,s]);return m.jsx("circle",{cx:r,cy:i,r:6,fill:"#6b7280",stroke:"white",strokeWidth:2,style:{cursor:"crosshair",outline:"none"},onPointerDown:u,onDoubleClick:d,onKeyDown:g,tabIndex:0,className:"nodrag nopan","aria-label":`Edge waypoint ${t+1}. Arrow keys to move, Delete to remove.`,role:"button"})});O.displayName="EdgeControlPoint";O.__docgenInfo={description:`Draggable waypoint handle rendered as an SVG circle on a selected edge.
- Drag (mouse or touch) to move the waypoint.
- Arrow keys to nudge the waypoint (10px per press).
- Double-click or Delete/Backspace to remove the waypoint.`,methods:[],displayName:"EdgeControlPoint",props:{edgeId:{required:!0,tsType:{name:"string"},description:""},index:{required:!0,tsType:{name:"number"},description:""},x:{required:!0,tsType:{name:"number"},description:""},y:{required:!0,tsType:{name:"number"},description:""},onMove:{required:!0,tsType:{name:"signature",type:"function",raw:"(index: number, point: { x: number; y: number }) => void",signature:{arguments:[{type:{name:"number"},name:"index"},{type:{name:"signature",type:"object",raw:"{ x: number; y: number }",signature:{properties:[{key:"x",value:{name:"number",required:!0}},{key:"y",value:{name:"number",required:!0}}]}},name:"point"}],return:{name:"void"}}},description:""},onRemove:{required:!0,tsType:{name:"signature",type:"function",raw:"(index: number) => void",signature:{arguments:[{type:{name:"number"},name:"index"}],return:{name:"void"}}},description:""}}};const Q=$.memo(({edgeId:e,waypoints:t})=>{const{setEdges:r}=pe(),i=$.useCallback((s,l)=>{r(u=>u.map(d=>{var p;if(d.id!==e)return d;const c=[...((p=d.data)==null?void 0:p.waypoints)??[]];return c[s]=l,{...d,data:{...d.data,waypoints:c}}}))},[e,r]),n=$.useCallback(s=>{r(l=>l.map(u=>{var c;if(u.id!==e)return u;const g=(((c=u.data)==null?void 0:c.waypoints)??[]).filter((p,h)=>h!==s);return{...u,data:{...u.data,waypoints:g.length>0?g:void 0}}}))},[e,r]);return m.jsx(m.Fragment,{children:t.map((s,l)=>m.jsx(O,{edgeId:e,index:l,x:s.x,y:s.y,onMove:i,onRemove:n},`${e}-cp-${l}`))})});Q.displayName="EdgeControllers";Q.__docgenInfo={description:`Renders draggable control handles at each waypoint of a selected edge.
Handles persist waypoint changes into React Flow edge state.`,methods:[],displayName:"EdgeControllers",props:{edgeId:{required:!0,tsType:{name:"string"},description:""},waypoints:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:"{ x: number; y: number }",signature:{properties:[{key:"x",value:{name:"number",required:!0}},{key:"y",value:{name:"number",required:!0}}]}}],raw:"Array<{ x: number; y: number }>"},description:""}}};const me=$.memo(({id:e,source:t,target:r,sourceX:i,sourceY:n,targetX:s,targetY:l,sourcePosition:u,targetPosition:d,sourceHandleId:g,targetHandleId:c,style:p={},markerEnd:h,label:y,labelStyle:x,selected:v,data:o})=>{var re,se,ie,le;const[E,w]=$.useState(!1),[N,C]=$.useState(!1),R=ke(),A=ye(f=>f.pushNavigation),Y=ye(f=>f.setLastError),S=ve(),F=Ee();let j=i,D=n,T=s,U=l;const J=10;if(!g){const f=F.filter(a=>a.source===t&&!a.sourceHandle).sort((a,q)=>a.id.localeCompare(q.id)),b=f.findIndex(a=>a.id===e);if(b!==-1&&f.length>1){const a=(b-(f.length-1)/2)*J;u==="top"||u==="bottom"?j+=a:D+=a}}if(!c){const f=F.filter(a=>a.target===r&&!a.targetHandle).sort((a,q)=>a.id.localeCompare(q.id)),b=f.findIndex(a=>a.id===e);if(b!==-1&&f.length>1){const a=(b-(f.length-1)/2)*J;d==="top"||d==="bottom"?T+=a:U+=a}}let L;const H=o==null?void 0:o.waypoints;if(H&&H.length>0)L=[{x:j,y:D},...H,{x:T,y:U}];else{const f=S.filter(M=>M.id!==t&&M.id!==r&&M.type!=="layerContainer").map(M=>{var ce,ae;return{x:M.position.x,y:M.position.y,width:((ce=M.measured)==null?void 0:ce.width)??M.width??200,height:((ae=M.measured)==null?void 0:ae.height)??M.height??100}}),b=S.find(M=>M.id===t),a=S.find(M=>M.id===r),q=b?{x:b.position.x,y:b.position.y,width:((re=b.measured)==null?void 0:re.width)??b.width??200,height:((se=b.measured)==null?void 0:se.height)??b.height??100}:void 0,we=a?{x:a.position.x,y:a.position.y,width:((ie=a.measured)==null?void 0:ie.width)??a.width??200,height:((le=a.measured)==null?void 0:le.height)??a.height??100}:void 0;L=Te({sourceX:j,sourceY:D,targetX:T,targetY:U,sourcePosition:u,targetPosition:d,obstacles:f,sourceRect:q,targetRect:we})}const B=Ie(L);let W=0,_=0;if(L.length>1){const f=Math.floor((L.length-1)/2),b=L[f],a=L[f+1];W=(b.x+a.x)/2,_=(b.y+a.y)/2}const k=!!(o!=null&&o.targetLayer),Z=k?Me(o.targetLayer):void 0,I=k?$e(o.targetLayer):(o==null?void 0:o.color)??"#6b7280",fe=k?"5,5":(o==null?void 0:o.strokeDasharray)??void 0,ee=E||N?3:2,V=async f=>{if(f.stopPropagation(),!(!k||!(o!=null&&o.targetLayer)||!r))try{const b=window.matchMedia("(prefers-reduced-motion: reduce)").matches;A({layerId:o.targetLayer,elementId:r,elementName:o.targetElementName||"Unknown Element",timestamp:Date.now()}),await R({to:`/${o.targetLayer.toLowerCase()}`,search:a=>({...a,selectedElement:r,skipAnimation:b})})}catch(b){const a=b instanceof Error?b.message:"Unknown error";console.error("Failed to navigate via cross-layer edge:",{sourceElement:o==null?void 0:o.sourceElementName,targetElement:o==null?void 0:o.targetElementName,targetLayer:o==null?void 0:o.targetLayer,error:a}),Y({message:`Failed to navigate to ${(o==null?void 0:o.targetElementName)||"target"}: ${a}`,timestamp:Date.now(),type:"navigation_failed",sourceElement:o==null?void 0:o.sourceElementName,targetElement:o==null?void 0:o.targetElementName})}},be=f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),V(f).catch(b=>{console.error("Keyboard navigation failed:",b)}))},ne=k?`Cross-layer link from ${(o==null?void 0:o.sourceElementName)||"Unknown"} to ${(o==null?void 0:o.targetElementName)||"Unknown"} in ${Z}, relationship type ${(o==null?void 0:o.relationshipType)||"Unknown"}. Press Enter to navigate.`:y?`Connection labeled ${y} from node ${t} to node ${r}`:`Connection from node ${t} to node ${r}`,te=L.slice(1,-1),P=k?o!=null&&o.relationshipType&&(o!=null&&o.targetElementName)?`${o.relationshipType}: ${o.targetElementName}`:(o==null?void 0:o.label)||(o==null?void 0:o.relationshipType):void 0,oe=P&&P.length>30?`${P.slice(0,27)}...`:P;return m.jsxs(m.Fragment,{children:[m.jsx(ue,{id:e,path:B,markerEnd:h,style:{stroke:I,strokeWidth:ee,strokeDasharray:fe,opacity:k?.8:void 0,cursor:k?"pointer":void 0,transition:N?"none":k?"stroke-width 200ms ease-out":void 0,...p},className:"react-flow__edge-path","aria-label":ne,role:k?"button":"img",onClick:k?V:void 0,onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1)}),N&&k&&m.jsx(ue,{id:`${e}-focus-ring`,path:B,style:{stroke:"#3b82f6",strokeWidth:ee+2,strokeDasharray:"5,5",opacity:.5,pointerEvents:"none"}}),v&&te.length>0&&m.jsx(Q,{edgeId:e,waypoints:te}),k&&oe&&m.jsx(G,{children:m.jsx("div",{style:{position:"absolute",transform:`translate(-50%, -50%) translate(${W}px,${_}px)`,background:"#ffffff",padding:"2px 6px",borderRadius:4,fontSize:10,fontWeight:500,color:I,border:`1px solid ${I}`,pointerEvents:"all",zIndex:10,whiteSpace:"nowrap"},className:"nodrag nopan",title:P,onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),onFocus:()=>C(!0),onBlur:()=>C(!1),tabIndex:-1,children:oe})}),!k&&y&&m.jsx(G,{children:m.jsx("div",{style:{position:"absolute",transform:`translate(-50%, -50%) translate(${W}px,${_}px)`,background:"#ffffff",padding:"2px 6px",borderRadius:4,fontSize:10,fontWeight:500,color:I,border:`1px solid ${I}`,pointerEvents:"all",zIndex:10,...x},className:"nodrag nopan",children:y})}),E&&k&&m.jsx(G,{children:m.jsxs("div",{style:{position:"absolute",transform:`translate(-50%, calc(-100% - 10px)) translate(${W}px,${_}px)`,background:"#ffffff",border:"1px solid #d1d5db",borderRadius:6,padding:"8px 10px",fontSize:12,zIndex:20,pointerEvents:"none",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",maxWidth:280},className:"nodrag nopan",children:[m.jsx("div",{className:"font-semibold text-gray-900 mb-2",children:(o==null?void 0:o.relationshipType)||"Relationship"}),m.jsxs("div",{className:"text-gray-700 space-y-1 text-xs",children:[m.jsxs("div",{children:[m.jsx("strong",{children:"From:"})," ",(o==null?void 0:o.sourceElementName)||"Unknown"]}),m.jsxs("div",{children:[m.jsx("strong",{children:"To:"})," ",(o==null?void 0:o.targetElementName)||"Unknown"]}),m.jsxs("div",{children:[m.jsx("strong",{children:"Target Layer:"})," ",Z]}),(o==null?void 0:o.label)&&m.jsxs("div",{children:[m.jsx("strong",{children:"Details:"})," ",o.label]})]})]})}),k&&m.jsx("path",{d:B,stroke:"transparent",strokeWidth:8,fill:"none",style:{cursor:"pointer",pointerEvents:"stroke"},onClick:V,onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),onFocus:()=>C(!0),onBlur:()=>C(!1),onKeyDown:be,tabIndex:0,role:"button","aria-label":ne,"data-testid":`cross-layer-edge-${e}`})]})});me.displayName="ElbowEdge";me.__docgenInfo={description:`Elbow Edge Component with A* obstacle avoidance and interactive waypoints.

- Routes around nodes using A* pathfinding with rounded corners.
- When selected, displays draggable waypoint handles.
- When edge.data.waypoints is set (by dragging handles), uses those points directly.
- When edge.data.targetLayer is set, acts as a navigable cross-layer edge with
  hover tooltips, focus ring, and click/keyboard navigation.`,methods:[],displayName:"ElbowEdge",props:{style:{defaultValue:{value:"{}",computed:!1},required:!1}}};export{me as E};

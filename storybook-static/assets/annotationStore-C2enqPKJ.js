import{l as p,E as c}from"./errorTracker-DrR4A8t3.js";import{c as w}from"./react-fqQoFC2C.js";const d="/api",I="dr_auth_token",g="dr_auth_token";function b(){if(typeof document>"u")return null;const o=document.cookie.split(";").map(e=>e.trim()).find(e=>e.startsWith(`${g}=`));if(!o)return null;try{return decodeURIComponent(o.split("=")[1]||"")}catch(e){return p(c.AUTH_COOKIE_DECODE_FAILED,"Cookie decode failed - token is malformed and cannot be used",{cookieName:g},e instanceof Error?e:new Error(String(e))),null}}async function u(o,e){if(!o.ok){if(o.status===401||o.status===403){const t=`Authentication failed (${o.status}). ${e}`;throw p(c.AUTH_REQUEST_FAILED,t,{context:e,statusCode:o.status},new Error(t)),new Error(t)}throw new Error(`Failed to ${e}: ${o.statusText}`)}}function f(){if(typeof window>"u")return{};const o=localStorage.getItem(I)||b();return o?{Authorization:`Bearer ${o}`}:{}}function C(o){if(typeof o!="object"||o===null)return!1;const e=o,t=e.operation;if(typeof e.timestamp!="string"||typeof e.element_id!="string"||typeof e.layer!="string"||typeof e.element_type!="string")return!1;switch(t){case"add":return typeof e.data=="object"&&e.data!==null;case"update":return typeof e.before=="object"&&e.before!==null&&typeof e.after=="object"&&e.after!==null;case"delete":return typeof e.before=="object"&&e.before!==null;default:return!1}}function T(o){if(!Array.isArray(o))throw new Error("Changes must be an array");for(let e=0;e<o.length;e++)if(!C(o[e]))throw new Error(`Invalid change at index ${e}: ${JSON.stringify(o[e])}`)}class _{async fetchJson(e,t,n){const a=await fetch(e,{headers:f(),credentials:"include",...n});return await u(a,t),await a.json()}async healthCheck(){return this.fetchJson("/health","health check")}async loadSpec(){const e=await fetch(`${d}/spec`,{headers:f(),credentials:"include"});await u(e,"load spec");const t=await e.json(),n=t.schemaCount??t.schema_count??(t.schemas?Object.keys(t.schemas).length:0),a=t.relationshipCatalog||t.relationship_catalog,i={version:t.version??"",type:t.type??"",schemas:t.schemas??{},schemaCount:n,relationshipCatalog:a};return typeof t.description=="string"&&(i.description=t.description),typeof t.source=="string"&&(i.source=t.source),t.manifest&&typeof t.manifest=="object"&&(i.manifest=t.manifest),i}async loadLayer(e){return await this.fetchJson(`${d}/layers/${encodeURIComponent(e)}`,`load layer ${e}`)}async loadElement(e){return await this.fetchJson(`${d}/elements/${encodeURIComponent(e)}`,`load element ${e}`)}async loadModel(){const e=await this.fetchJson(`${d}/model`,"load model");return(a=>{if(typeof a!="object"||a===null)return{};const r=a.statistics;if(typeof r!="object"||r===null)return{};const l=r;return{totalLayers:typeof l.total_layers=="number"?l.total_layers:void 0,totalElements:typeof l.total_elements=="number"?l.total_elements:void 0}})(e.metadata),this.normalizeModel(e)}normalizeModel(e){if(typeof e!="object"||e===null)throw new Error("Invalid model data: expected object");const t=e,n={version:typeof t.version=="string"?t.version:"1.0.0",layers:{},references:Array.isArray(t.references)?t.references:[]};typeof t.id=="string"&&(n.id=t.id),typeof t.name=="string"&&(n.name=t.name),typeof t.description=="string"&&(n.description=t.description),typeof t.metadata=="object"&&t.metadata!==null&&(n.metadata=t.metadata);for(const[a,i]of Object.entries(t.layers||{})){if(typeof i!="object"||i===null){p(c.DATA_NORMALIZATION_FAILED,"Invalid layer object encountered - skipping layer",{layerId:a,layerType:typeof i,context:"normalizeModel layer validation"});continue}const r=i,l={id:typeof r.id=="string"?r.id:a,type:typeof r.type=="string"?r.type:"unknown",name:typeof r.name=="string"?r.name:a,elements:this.normalizeElements(r.elements),relationships:Array.isArray(r.relationships)?r.relationships:[]};typeof r.description=="string"&&(l.description=r.description),typeof r.order=="number"&&(l.order=r.order),typeof r.data=="object"&&r.data!==null&&(l.data=r.data),n.layers[a]=l}return n}normalizeElements(e){return Array.isArray(e)?e.filter(t=>typeof t!="object"||t===null?(p(c.DATA_NORMALIZATION_FAILED,"Skipping non-object element in normalizeElements - possible server data corruption",{elementType:typeof t,element:t,context:"normalizeElements filter"}),!1):!0).map(t=>({id:typeof t.id=="string"?t.id:"",type:typeof t.type=="string"?t.type:"",name:typeof t.name=="string"?t.name:"",layerId:typeof t.layerId=="string"?t.layerId:"",properties:typeof t.properties=="object"&&t.properties!==null?t.properties:{},visual:this.normalizeVisual(t.visual)})):(p(c.DATA_NORMALIZATION_FAILED,"Expected elements array but received non-array - possible server data corruption",{elementType:typeof e,context:"normalizeElements non-array check"}),[])}normalizeVisual(e){const t={position:{x:0,y:0},size:{width:200,height:100},style:{backgroundColor:"#e3f2fd",borderColor:"#1976d2"}};if(typeof e!="object"||e===null)return e!==void 0&&p(c.DATA_NORMALIZATION_FAILED,"Invalid visual data structure - using default visual values",{visualType:typeof e,visual:e,context:"normalizeVisual - null/invalid input"}),t;const n=e;let a=t.position;if(typeof n.position=="object"&&n.position!==null){const s=n.position;typeof s.x=="number"&&typeof s.y=="number"?a={x:s.x,y:s.y}:p(c.DATA_NORMALIZATION_FAILED,"Invalid position data in visual properties - using default position",{position:n.position,context:"normalizeVisual - position"})}let i=t.size;if(typeof n.size=="object"&&n.size!==null){const s=n.size;typeof s.width=="number"&&typeof s.height=="number"?i={width:s.width,height:s.height}:p(c.DATA_NORMALIZATION_FAILED,"Invalid size data in visual properties - using default size",{size:n.size,context:"normalizeVisual - size"})}let r=t.style;if(typeof n.style=="object"&&n.style!==null){const s=n.style;r={backgroundColor:typeof s.backgroundColor=="string"?s.backgroundColor:r.backgroundColor,borderColor:typeof s.borderColor=="string"?s.borderColor:r.borderColor,borderStyle:typeof s.borderStyle=="string"?s.borderStyle:void 0,textColor:typeof s.textColor=="string"?s.textColor:void 0,icon:typeof s.icon=="string"?s.icon:void 0,shape:typeof s.shape=="string"?s.shape:void 0}}let l;return typeof n.layoutHints=="object"&&n.layoutHints!==null&&(l=n.layoutHints),{position:a,size:i,style:r,...l&&{layoutHints:l}}}async loadChangesetRegistry(){return await this.fetchJson(`${d}/changesets`,"load changesets")}async loadChangeset(e){const t=await this.fetchJson(`${d}/changesets/${encodeURIComponent(e)}`,`load changeset ${e}`);return t.changes&&Array.isArray(t.changes.changes)&&T(t.changes.changes),t}async getChangesetList(){const e=await this.loadChangesetRegistry();return Object.entries(e.changesets||{}).map(([t,n])=>({id:t,...n}))}async loadAnnotations(){const e=await fetch(`${d}/annotations`,{headers:f(),credentials:"include"});return await u(e,"load annotations"),(await e.json()).annotations||[]}async loadAnnotationsForElement(e){const t=await fetch(`${d}/annotations?elementId=${encodeURIComponent(e)}`,{headers:f(),credentials:"include"});return await u(t,"load annotations for element"),(await t.json()).annotations||[]}async createAnnotation(e){const t=await fetch(`${d}/annotations`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(e),credentials:"include"});return await u(t,"create annotation"),await t.json()}async updateAnnotation(e,t){const n=await fetch(`${d}/annotations/${encodeURIComponent(e)}`,{method:"PATCH",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(t),credentials:"include"});return await u(n,"update annotation"),await n.json()}async resolveAnnotation(e){return this.updateAnnotation(e,{resolved:!0})}async unresolveAnnotation(e){return this.updateAnnotation(e,{resolved:!1})}async loadAnnotationReplies(e){const t=await fetch(`${d}/annotations/${encodeURIComponent(e)}/replies`,{headers:f(),credentials:"include"});return await u(t,`load replies for annotation ${e}`),(await t.json()).replies||[]}async createAnnotationReply(e,t){const n=await fetch(`${d}/annotations/${encodeURIComponent(e)}/replies`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(t),credentials:"include"});return await u(n,"create annotation reply"),await n.json()}async deleteAnnotation(e){const t=await fetch(`${d}/annotations/${encodeURIComponent(e)}`,{method:"DELETE",headers:f(),credentials:"include"});await u(t,"delete annotation")}}const h=new _;function A(o,e,t,n,a,i){throw o({error:t}),i&&i(),p(e,t,n,a instanceof Error?a:new Error(String(a))),a}const N=w((o,e)=>({annotations:[],selectedElementId:null,highlightedElementId:null,loading:!1,error:null,setAnnotations:t=>o({annotations:t}),addAnnotation:t=>o(n=>({annotations:[...n.annotations,t]})),updateAnnotation:(t,n)=>o(a=>({annotations:a.annotations.map(i=>i.id===t?{...i,...n}:i)})),removeAnnotation:t=>o(n=>({annotations:n.annotations.filter(a=>a.id!==t)})),setSelectedElementId:t=>o({selectedElementId:t}),setHighlightedElementId:t=>o({highlightedElementId:t}),setLoading:t=>o({loading:t}),setError:t=>o({error:t}),reset:()=>o({annotations:[],selectedElementId:null,highlightedElementId:null,loading:!1,error:null}),createAnnotation:async(t,n,a)=>{const i=`temp-${Date.now()}`,r={id:i,elementId:t,author:a,content:n,createdAt:new Date().toISOString(),resolved:!1};try{o({error:null}),e().addAnnotation(r);const l=await h.createAnnotation({elementId:t,content:n,author:a});o(s=>({annotations:s.annotations.map(y=>y.id===i?l:y)}))}catch(l){const s=l instanceof Error?l.message:"Failed to create annotation";A(o,c.ANNOTATION_CREATE_FAILED,s,{elementId:t,author:a},l,()=>e().removeAnnotation(i))}},resolveAnnotation:async t=>{try{o({error:null}),e().updateAnnotation(t,{resolved:!0}),await h.resolveAnnotation(t)}catch(n){const a=n instanceof Error?n.message:"Failed to resolve annotation";A(o,c.ANNOTATION_RESOLVE_FAILED,a,{annotationId:t},n,()=>e().updateAnnotation(t,{resolved:!1}))}},unresolveAnnotation:async t=>{try{o({error:null}),e().updateAnnotation(t,{resolved:!1}),await h.unresolveAnnotation(t)}catch(n){const a=n instanceof Error?n.message:"Failed to unresolve annotation";A(o,c.ANNOTATION_RESOLVE_FAILED,a,{annotationId:t},n,()=>e().updateAnnotation(t,{resolved:!0}))}},loadAnnotationReplies:async t=>{try{o({error:null});const n=await h.loadAnnotationReplies(t);e().updateAnnotation(t,{replies:n})}catch(n){const a=n instanceof Error?n.message:"Failed to load replies";A(o,c.ANNOTATION_REPLY_FAILED,a,{annotationId:t},n)}},createAnnotationReply:async(t,n,a)=>{try{o({error:null});const i=await h.createAnnotationReply(t,{author:n,content:a}),r=e().annotations.find(l=>l.id===t);if(r){const l=[...r.replies||[],i];e().updateAnnotation(t,{replies:l})}}catch(i){const r=i instanceof Error?i.message:"Failed to create reply";A(o,c.ANNOTATION_REPLY_FAILED,r,{annotationId:t,author:n},i)}},deleteAnnotation:async t=>{const n=e().annotations,a=n.findIndex(r=>r.id===t),i=n[a];if(!i){const r=`Annotation not found: ${t}`;throw o({error:r}),p(c.ANNOTATION_DELETE_FAILED,r,{annotationId:t},new Error(r)),new Error(r)}try{o({error:null}),e().removeAnnotation(t),await h.deleteAnnotation(t)}catch(r){const l=r instanceof Error?r.message:"Failed to delete annotation",s=()=>{i&&!e().annotations.find(y=>y.id===t)&&o(y=>{const m=[...y.annotations],E=Math.min(a,m.length);return m.splice(E,0,i),{annotations:m}})};A(o,c.ANNOTATION_DELETE_FAILED,l,{annotationId:t},r,s)}},getAnnotationsForElement:t=>{const{annotations:n}=e();return n.filter(a=>a.elementId===t)},getAnnotationCount:()=>e().annotations.length,getUnresolvedCount:()=>e().annotations.filter(t=>!t.resolved).length}));export{N as u};

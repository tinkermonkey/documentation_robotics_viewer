var ot=Object.defineProperty;var at=(r,e,s)=>e in r?ot(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var k=(r,e,s)=>at(r,typeof e!="symbol"?e+"":e,s);import{r as w,j as p}from"./iframe-DSSgKmXl.js";import{M as it,u as ct,a as lt,i as dt,e as ut,C as pt,f as oe,R as z}from"./index-DzsatpJz.js";import{a as ae,b as ie}from"./BusinessProcessNode-CEovaBVo.js";import{B as mt,a as ht}from"./BusinessFunctionNode-C-nMuTrs.js";import{B as ft,a as gt}from"./BusinessServiceNode-DRch8gwd.js";import{B as yt,a as wt}from"./BusinessCapabilityNode-BB0Hhw9z.js";import"./LayerContainerNode-BdSyy50l.js";import"./StakeholderNode-D0JWtkck.js";import"./GoalNode-DI1x_tTR.js";import"./RequirementNode-bkA4lIr6.js";import"./ConstraintNode-BqB5kbEd.js";import"./DriverNode-C3erhlff.js";import"./OutcomeNode-B_fS7xwn.js";import"./PrincipleNode-TyyAOrO3.js";import"./AssumptionNode-DQpbG6Z-.js";import"./ValueStreamNode-BnfekKN_.js";import"./AssessmentNode-DkjSth4j.js";import"./ContainerNode-CHJOD5FR.js";import"./ComponentNode-DvHZgqIt.js";import"./ExternalActorNode-3I-nxaqe.js";import"./JSONSchemaNode-DkRy3iIA.js";import{d as ce,e as xt,n as bt}from"./index-vkQmDB7O.js";import{u as St,a as Et,B as vt}from"./BusinessLayerControls-DrH-pRR4.js";import{P as It}from"./ProcessInspectorPanel-D1QTp-BE.js";import{M as Lt}from"./MiniMap-CP89tgTE.js";import{g as Ct}from"./layerColors-Dv3sYeJV.js";import{c as X,a as Rt}from"./modelFixtures-nuBusyic.js";import{S as W}from"./StoryLoadedWrapper-D92HWVD9.js";import"./preload-helper-Dp1pzeXC.js";import"./index-DVMEuaP3.js";import"./index-B3kNdT8l.js";import"./index-CsUALWJS.js";import"./BaseLayerNode-CrjxDnkb.js";import"./RelationshipBadge-BEAv2yu2.js";import"./BaseFieldListNode-bvohYiE_.js";import"./ElbowEdge-BkIQb77y.js";import"./useNavigate-CEEZa2t9.js";import"./crossLayerStore-Bec5Tsd5.js";import"./react-fqQoFC2C.js";import"./BaseInspectorPanel-BBWNLuHC.js";import"./RenderPropErrorBoundary-C5UeOkUJ.js";import"./Button-DjdbHWkm.js";import"./create-theme-BOkxhGns.js";import"./x-BvdhAmd6.js";import"./createLucideIcon-CIvKt9yE.js";import"./Card-dBO4-pIe.js";import"./Badge-4uEMzFcW.js";import"./BaseControlPanel-D-ZWsrS_.js";import"./Label-BgBB6PcL.js";import"./Spinner-Al2eUyHo.js";import"./GraphViewSidebar-BmDrn4TD.js";import"./AccordionTitle-Cun89kOD.js";import"./chevron-down-icon-CIJfcLG8.js";import"./NavigationErrorNotification-BQSize9i.js";import"./index-NvR17eTZ.js";import"./Alert-B-2krvq0.js";import"./download-GiEPQcXk.js";class kt{constructor(){k(this,"elementIndex",new Map);k(this,"relationshipIndex",new Map);k(this,"warnings",[])}parseBusinessLayer(e){this.clearState();const s=this.findBusinessLayer(e);if(!s)throw new Error("No business layer found in model");const t=this.extractBusinessElements(s.elements),o=this.extractBusinessRelationships(s.relationships||[]);this.buildElementIndex(t),this.buildRelationshipIndex(o);const a=this.calculateMetadata(t,o);return{elements:t,relationships:o,metadata:a}}extractBusinessElements(e){const s=[];for(const t of e)try{if(!t.id||!t.name){this.warnings.push(`Skipping element with missing id or name: ${JSON.stringify(t)}`);continue}const o={id:t.id,type:this.normalizeElementType(t.type),name:t.name,description:t.description,properties:t.properties||{},relationships:[]};s.push(o)}catch(o){const a=o instanceof Error?o.message:String(o);this.warnings.push(`Failed to extract element ${t.id}: ${a}`)}return s}extractBusinessRelationships(e){const s=[];for(const t of e)try{if(!t.id||!t.sourceId||!t.targetId){this.warnings.push(`Skipping relationship with missing fields: ${JSON.stringify(t)}`);continue}const o={id:t.id,type:this.normalizeRelationshipType(t.type),sourceId:t.sourceId,targetId:t.targetId,properties:t.properties||{}};s.push(o)}catch(o){const a=o instanceof Error?o.message:String(o);this.warnings.push(`Failed to extract relationship ${t.id}: ${a}`)}return s}validateBusinessRelationships(e){const s=[],t=[],o=new Set(e.map(n=>n.id));for(const n of e)for(const i of n.relationships)o.has(i.targetId)||t.push(`Element ${n.id} has relationship to non-existent element ${i.targetId}`);const a=new Map;for(const n of e)a.set(n.id,(a.get(n.id)||0)+1);for(const[n,i]of a.entries())i>1&&s.push(`Duplicate element ID found: ${n} (${i} occurrences)`);return{valid:s.length===0,errors:s,warnings:t}}getWarnings(){return this.warnings}getElement(e){return this.elementIndex.get(e)}getRelationships(e){return this.relationshipIndex.get(e)||[]}findBusinessLayer(e){const s="business";for(const[t,o]of Object.entries(e.layers))if(t.toLowerCase()===s)return o;return null}normalizeElementType(e){const s={function:"function",functions:"function",process:"process",processes:"process",service:"service",services:"service",capability:"capability",capabilities:"capability"},t=e.toLowerCase().trim();return s[t]||e}normalizeRelationshipType(e){if(typeof e!="string")return"custom";const s={realizes:"realizes",realization:"realizes",supports:"supports",support:"supports",flows_to:"flows_to",flow:"flows_to",depends_on:"depends_on",dependency:"depends_on",serves:"serves",serving:"serves",composes:"composes",composition:"composes",aggregates:"aggregates",aggregation:"aggregates"},t=e.toLowerCase().trim().replace(/[-_\s]/g,"_");return s[t]||e}buildElementIndex(e){this.elementIndex.clear();for(const s of e)this.elementIndex.set(s.id,s)}buildRelationshipIndex(e){this.relationshipIndex.clear();for(const s of e){const t=this.relationshipIndex.get(s.sourceId)||[];t.push(s),this.relationshipIndex.set(s.sourceId,t)}}calculateMetadata(e,s){const t={};for(const o of e)t[o.type]=(t[o.type]||0)+1;return{elementCount:e.length,relationshipCount:s.length,elementsByType:t}}clearState(){this.elementIndex.clear(),this.relationshipIndex.clear(),this.warnings=[]}}class Dt{constructor(){k(this,"warnings",[])}buildGraph(e,s){this.warnings=[];const t=this.buildNodes(e),o=this.buildEdges(s,t),a=this.resolveHierarchy(t,o),n=this.calculateMetrics(t,o,a),i=this.buildIndices(t);return{nodes:t,edges:o,hierarchy:a,metrics:n,crossLayerLinks:[],indices:i}}resolveHierarchy(e,s){const t=new Map,o=new Map,a=new Map,n=[],i=[];for(const d of s.values())if(d.type==="composes"||d.type==="aggregates"){const u=d.source,m=d.target,x=t.get(u)||[];x.push(m),t.set(u,x),o.set(m,u)}for(const d of e.values())d.childIds=t.get(d.id)||[],d.parentId=o.get(d.id);for(const d of e.values())d.parentId||n.push(d.id);const c=new Set;let l=0,h=[...n];for(;h.length>0;){const d=new Set;for(const m of h){if(c.has(m)){this.warnings.push(`Circular hierarchy reference detected for node ${m}`);continue}const x=e.get(m);x&&(x.hierarchyLevel=l,d.add(m),c.add(m))}a.set(l,d);const u=[];for(const m of h){const x=t.get(m)||[];u.push(...x)}h=u,l++}for(const d of e.values())d.childIds.length===0&&i.push(d.id);return{maxDepth:Math.max(0,l-1),rootNodes:n,leafNodes:i,nodesByLevel:a,parentChildMap:t,childParentMap:o}}calculateMetrics(e,s,t){const o=e.size,a=s.size,n=o>0?a/o:0,i=this.detectCircularDependencies(e,s),c=[];for(const h of e.values()){const y=Array.from(s.values()).some(u=>u.target===h.id),d=Array.from(s.values()).some(u=>u.source===h.id);!y&&!d&&c.push(h.id)}const l=[];for(const h of e.values())h.metadata.criticality==="high"&&l.push(h.id);return{nodeCount:o,edgeCount:a,averageConnectivity:n,maxHierarchyDepth:t.maxDepth,circularDependencies:i,orphanedNodes:c,criticalNodes:l}}getWarnings(){return this.warnings}buildNodes(e){const s=new Map;for(const t of e)try{const o={id:t.id,type:this.inferNodeType(t.type),name:t.name,description:t.description,properties:t.properties,metadata:this.extractMetadata(t),hierarchyLevel:0,parentId:void 0,childIds:[],dimensions:this.calculateDimensions(t)};s.set(o.id,o)}catch(o){const a=o instanceof Error?o.message:String(o);this.warnings.push(`Failed to build node for element ${t.id}: ${a}`)}return s}buildEdges(e,s){var o;const t=new Map;for(const a of e)try{if(!s.has(a.sourceId)){this.warnings.push(`Relationship ${a.id} references non-existent source ${a.sourceId}`);continue}if(!s.has(a.targetId)){this.warnings.push(`Relationship ${a.id} references non-existent target ${a.targetId}`);continue}const n={id:a.id,source:a.sourceId,sourceId:a.sourceId,target:a.targetId,targetId:a.targetId,type:this.inferEdgeType(a.type),label:(o=a.properties)==null?void 0:o.label,properties:a.properties};t.set(n.id,n)}catch(n){const i=n instanceof Error?n.message:String(n);this.warnings.push(`Failed to build edge for relationship ${a.id}: ${i}`)}return t}inferNodeType(e){const s=e.toLowerCase();return s.includes("function")?"function":s.includes("process")?"process":s.includes("service")?"service":s.includes("capability")?"capability":"function"}inferEdgeType(e){const s=e.toLowerCase();return{realizes:"realizes",supports:"supports",flows_to:"flows_to",depends_on:"depends_on",serves:"serves",composes:"composes",aggregates:"aggregates"}[s]||"serves"}extractMetadata(e){const s=e.properties;return{owner:s.owner,criticality:this.parseCriticality(s.criticality),lifecycle:this.parseLifecycle(s.lifecycle),domain:s.domain,subprocessCount:s.subprocessCount,stepCount:s.stepCount}}parseCriticality(e){if(typeof e!="string")return;const s=e.toLowerCase();if(s==="high"||s==="critical")return"high";if(s==="medium"||s==="normal")return"medium";if(s==="low")return"low"}parseLifecycle(e){if(typeof e!="string")return;const s=e.toLowerCase();if(s==="ideation"||s==="planned")return"ideation";if(s==="active"||s==="current")return"active";if(s==="deprecated"||s==="retired")return"deprecated"}calculateDimensions(e){let o=200,a=100;const n=e.type.toLowerCase();return n.includes("process")?(o=220,a=120):n.includes("service")?(o=200,a=100):n.includes("capability")&&(o=240,a=110),{width:o,height:a}}buildIndices(e){const s=new Map,t=new Map,o=new Map,a=new Map;for(const n of e.values()){const i=s.get(n.type)||new Set;if(i.add(n.id),s.set(n.type,i),n.metadata.domain){const c=t.get(n.metadata.domain)||new Set;c.add(n.id),t.set(n.metadata.domain,c)}if(n.metadata.lifecycle){const c=o.get(n.metadata.lifecycle)||new Set;c.add(n.id),o.set(n.metadata.lifecycle,c)}if(n.metadata.criticality){const c=a.get(n.metadata.criticality)||new Set;c.add(n.id),a.set(n.metadata.criticality,c)}}return{byType:s,byDomain:t,byLifecycle:o,byCriticality:a}}detectCircularDependencies(e,s){const t=[],o=new Set,a=new Set,n=new Map;for(const c of s.values())if(c.type==="depends_on"||c.type==="flows_to"){const l=n.get(c.source)||[];l.push(c.target),n.set(c.source,l)}const i=(c,l)=>{o.add(c),a.add(c),l.push(c);const h=n.get(c)||[];for(const y of h)if(!o.has(y))i(y,[...l]);else if(a.has(y)){const d=l.indexOf(y),u=l.slice(d);u.push(y),t.push({cycle:u,type:"depends_on"})}a.delete(c)};for(const c of e.keys())o.has(c)||i(c,[]);return t}}class ke{precalculateDimensions(e){for(const s of e.values())s.dimensions=this.getNodeDimensions(s)}getNodeDimensions(e){switch(e.type){case"process":return{width:ie,height:ae};case"function":return{width:ht,height:mt};case"service":return{width:gt,height:ft};case"capability":return{width:wt,height:yt};default:return{width:ie,height:ae}}}getNodeType(e){switch(e.type){case"process":return"businessProcess";case"function":return"businessFunction";case"service":return"businessService";case"capability":return"businessCapability";default:return"businessProcess"}}extractNodeData(e){const s=this.getNodeType(e),t={label:e.name,elementId:e.id,layerId:"business",fill:this.getFillColor(e),stroke:this.getStrokeColor(e),owner:e.metadata.owner,criticality:e.metadata.criticality,lifecycle:e.metadata.lifecycle,domain:e.metadata.domain};return s==="businessProcess"?{...t,subprocessCount:e.metadata.subprocessCount||e.childIds.length,stepCount:e.metadata.stepCount,hierarchyLevel:e.hierarchyLevel}:t}getFillColor(e){let t={process:"#FFF3E0",function:"#E3F2FD",service:"#F3E5F5",capability:"#E8F5E9"}[e.type]||"#F5F5F5";return e.metadata.lifecycle==="deprecated"&&(t="#EEEEEE"),t}getStrokeColor(e){return e.metadata.criticality==="high"?"#D32F2F":{process:"#E65100",function:"#1565C0",service:"#6A1B9A",capability:"#2E7D32"}[e.type]||"#424242"}}class Tt{constructor(){k(this,"warnings",[])}resolveAllLinks(e,s){this.warnings=[];const t=[];return t.push(...this.resolveMotivationLinks(e,s)),t.push(...this.resolveApplicationLinks(e,s)),t.push(...this.resolveDataModelLinks(e,s)),t.push(...this.resolveSecurityLinks(e,s)),t.push(...this.resolveAPILinks(e,s)),t.push(...this.resolveUXLinks(e,s)),e.crossLayerLinks=t,e}resolveMotivationLinks(e,s){const t=[],o=this.findLayer(s,"Motivation");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.nodes.values()){const i=this.extractReferenceArray(n.properties,"realizes"),c=this.extractReferenceArray(n.properties,"supports");for(const l of[...i,...c])a.has(l)?t.push({source:n.id,target:l,sourceLayer:"business",targetLayer:"motivation",type:"realizes"}):this.warnings.push(`Business node ${n.id} references non-existent motivation element ${l}`)}for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"motivation",type:n.type});return t}resolveApplicationLinks(e,s){const t=[],o=this.findLayer(s,"Application");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.edges.values())n.type==="realizes"&&a.has(n.target)&&t.push({source:n.source,target:n.target,sourceLayer:"business",targetLayer:"application",type:"realizes"});for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"application",type:n.type});return t}resolveDataModelLinks(e,s){const t=[],o=this.findLayer(s,"DataModel");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.nodes.values()){const i=this.extractReferenceArray(n.properties,"accesses"),c=this.extractReferenceArray(n.properties,"uses");for(const l of[...i,...c])a.has(l)&&t.push({source:n.id,target:l,sourceLayer:"business",targetLayer:"data_model",type:"accesses"})}for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"data_model",type:n.type});return t}resolveSecurityLinks(e,s){const t=[],o=this.findLayer(s,"Security");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.nodes.values()){const i=this.extractReferenceArray(n.properties,"secured_by"),c=this.extractReferenceArray(n.properties,"requires_permissions");for(const l of[...i,...c])a.has(l)&&t.push({source:n.id,target:l,sourceLayer:"business",targetLayer:"security",type:"secured_by"})}for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"security",type:n.type});return t}resolveAPILinks(e,s){const t=[],o=this.findLayer(s,"Api");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.nodes.values())if(n.type==="service"){const i=this.extractReferenceArray(n.properties,"exposed_by"),c=this.extractReferenceArray(n.properties,"uses_api");for(const l of[...i,...c])a.has(l)&&t.push({source:n.id,target:l,sourceLayer:"business",targetLayer:"api",type:"exposed_by"})}for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"api",type:n.type});return t}resolveUXLinks(e,s){const t=[],o=this.findLayer(s,"Ux");if(!o)return t;const a=new Set(o.elements.map(n=>n.id));for(const n of e.nodes.values()){const i=this.extractReferenceArray(n.properties,"triggered_by");for(const c of i)a.has(c)&&t.push({source:n.id,target:c,sourceLayer:"business",targetLayer:"ux",type:"triggered_by"})}for(const n of s.references||[])n.source.elementId&&e.nodes.has(n.source.elementId)&&n.target.elementId&&a.has(n.target.elementId)&&t.push({source:n.source.elementId,target:n.target.elementId,sourceLayer:"business",targetLayer:"ux",type:n.type});return t}getWarnings(){return this.warnings}findLayer(e,s){const t=s.toLowerCase();for(const[o,a]of Object.entries(e.layers))if(o.toLowerCase()===t)return a;return null}extractReferenceArray(e,s){const t=e[s];return t?typeof t=="string"?[t]:Array.isArray(t)?t.filter(o=>typeof o=="string"):[]:[]}}class Pt{constructor(){k(this,"transformer");this.transformer=new ke}getName(){return"Hierarchical Layout"}getDescription(){return"Top-down or left-right hierarchical layout showing process decomposition hierarchy"}async calculate(e,s){const t=performance.now();return e.nodes.size>100?this.calculateInWorker(e,s,t):this.calculateWithDagre(e,s,t)}async calculateInWorker(e,s,t){return new Promise((o,a)=>{const n=new Worker("/workers/layoutWorker.js"),i={nodes:Array.from(e.nodes.values()).map(l=>({id:l.id,name:l.name,type:l.type,dimensions:this.getNodeDimensions(l)})),edges:Array.from(e.edges.values()).map(l=>({id:l.id,source:l.source,target:l.target,type:l.type,label:l.label}))},c=setTimeout(()=>{n.terminate(),a(new Error("Layout worker timeout"))},3e4);n.onmessage=l=>{clearTimeout(c);const{success:h,positions:y,bounds:d,error:u}=l.data;if(!h){n.terminate(),a(new Error(u||"Unknown worker error"));return}const m=this.createReactFlowResult(e,y,d),x=performance.now()-t;m.metadata&&(m.metadata.calculationTime=x,m.metadata.usedWorker=!0),n.terminate(),o(m)},n.onerror=l=>{clearTimeout(c),n.terminate(),a(new Error(l.message||"Web Worker error"))},n.postMessage({graph:i,options:s})})}calculateWithDagre(e,s,t){const o=this.convertToDAG(e,s);ce.layout(o);const a=this.convertToReactFlow(o,e),n=performance.now()-t;return a.metadata&&(a.metadata.calculationTime=n,a.metadata.usedWorker=!1),a}convertToDAG(e,s){var o,a;const t=new ce.graphlib.Graph;t.setGraph({rankdir:s.direction||"TB",nodesep:((o=s.spacing)==null?void 0:o.node)||80,ranksep:((a=s.spacing)==null?void 0:a.rank)||120,marginx:30,marginy:30,align:"UL",ranker:"tight-tree"}),t.setDefaultEdgeLabel(()=>({}));for(const[n,i]of e.nodes.entries()){const c=this.getNodeDimensions(i);t.setNode(n,{width:c.width,height:c.height,label:i.name})}for(const n of e.edges.values())t.setEdge(n.source,n.target,{label:n.label||n.type,weight:this.getEdgeWeight(n)});return t}convertToReactFlow(e,s){const t=[];let o=1/0,a=-1/0,n=1/0,i=-1/0;for(const[l,h]of s.nodes.entries()){const y=e.node(l);if(!y)continue;const d=this.getNodeDimensions(h),u=y.x-d.width/2,m=y.y-d.height/2;o=Math.min(o,u),a=Math.max(a,u+d.width),n=Math.min(n,m),i=Math.max(i,m+d.height);const x={id:`node-${l}`,type:this.getNodeType(h),position:{x:u,y:m},data:this.extractNodeData(h),width:d.width,height:d.height};t.push(x)}const c=this.convertEdges(s);return{nodes:t,edges:c,metadata:{calculationTime:0,bounds:{width:a-o,height:i-n,minX:o,maxX:a,minY:n,maxY:i}}}}convertEdges(e){const s=[];for(const[t,o]of e.edges.entries()){const a={id:`edge-${t}`,source:`node-${o.source}`,target:`node-${o.target}`,type:"elbow",label:o.label||o.type,labelStyle:{fill:"#555",fontWeight:500,fontSize:12},labelBgStyle:{fill:"#fff",fillOpacity:.8,rx:4,ry:4},markerEnd:{type:it.ArrowClosed,width:20,height:20,color:"#6b7280"},data:{edgeType:o.type,pathOptions:{offset:10,borderRadius:8}}};s.push(a)}return s}getNodeType(e){switch(e.type){case"process":return"businessProcess";case"function":return"businessFunction";case"service":return"businessService";case"capability":return"businessCapability";default:return"businessProcess"}}getNodeDimensions(e){if(e.dimensions)return e.dimensions;switch(e.type){case"process":return{width:200,height:80};case"function":return{width:180,height:100};case"service":return{width:180,height:90};case"capability":return{width:160,height:70};default:return{width:200,height:100}}}extractNodeData(e){return this.transformer.extractNodeData(e)}getEdgeWeight(e){return e.type==="composes"||e.type==="aggregates"?10:1}createReactFlowResult(e,s,t){const o=[];for(const[n,i]of e.nodes.entries()){const c=s[n];if(!c){console.warn(`No position found for node ${n}`);continue}const l=this.getNodeDimensions(i),h={id:`node-${n}`,type:this.getNodeType(i),position:c,data:this.extractNodeData(i),width:l.width,height:l.height};o.push(h)}const a=this.convertEdges(e);return{nodes:o,edges:a,metadata:{calculationTime:0,bounds:t}}}}const Ft={algorithm:"hierarchical",direction:"TB",spacing:{node:80,rank:120,lane:200},animate:!0,animationDuration:800};function Nt(r,e,s,t){return w.useMemo(()=>$t(r,e,s,t),[r,e,s,t])}function $t(r,e,s,t){if(!t||e==="none"||r.size===0)return{focusedNodes:new Set,focusedEdges:new Set,dimmedNodes:new Set};const o=new Set(r),a=new Set;e==="selected"?r.forEach(i=>{q(i,s,t,o,a)}):e==="upstream"?r.forEach(i=>{De(i,t,o,a)}):e==="downstream"?r.forEach(i=>{Te(i,t,o,a)}):e==="radial"&&r.forEach(i=>{q(i,1,t,o,a)});const n=new Set;return t.nodes.forEach((i,c)=>{o.has(c)||n.add(c)}),{focusedNodes:o,focusedEdges:a,dimmedNodes:n}}function q(r,e,s,t,o){if(e===0)return;const a=Mt(r,s);a.nodes.forEach(n=>{t.has(n)||(t.add(n),q(n,e-1,s,t,o))}),a.edges.forEach(n=>o.add(n))}function Mt(r,e){const s=new Set,t=new Set;return e.edges.forEach((o,a)=>{o.source===r?(s.add(o.target),t.add(a)):o.target===r&&(s.add(o.source),t.add(a))}),{nodes:s,edges:t}}function De(r,e,s,t){e.edges.forEach((o,a)=>{o.target===r&&!s.has(o.source)&&(s.add(o.source),t.add(a),De(o.source,e,s,t))})}function Te(r,e,s,t){e.edges.forEach((o,a)=>{o.source===r&&!s.has(o.target)&&(s.add(o.target),t.add(a),Te(o.target,e,s,t))})}function Bt(r,e){if(r.match(/^[a-z]+:\/\//i))return r;if(r.match(/^\/\//))return window.location.protocol+r;if(r.match(/^[a-z]+:/i))return r;const s=document.implementation.createHTMLDocument(),t=s.createElement("base"),o=s.createElement("a");return s.head.appendChild(t),s.body.appendChild(o),e&&(t.href=e),o.href=r,o.href}const At=(()=>{let r=0;const e=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(r+=1,`u${e()}${r}`)})();function C(r){const e=[];for(let s=0,t=r.length;s<t;s++)e.push(r[s]);return e}let T=null;function Pe(r={}){return T||(r.includeStyleProperties?(T=r.includeStyleProperties,T):(T=C(window.getComputedStyle(document.documentElement)),T))}function j(r,e){const t=(r.ownerDocument.defaultView||window).getComputedStyle(r).getPropertyValue(e);return t?parseFloat(t.replace("px","")):0}function _t(r){const e=j(r,"border-left-width"),s=j(r,"border-right-width");return r.clientWidth+e+s}function jt(r){const e=j(r,"border-top-width"),s=j(r,"border-bottom-width");return r.clientHeight+e+s}function Fe(r,e={}){const s=e.width||_t(r),t=e.height||jt(r);return{width:s,height:t}}function Ut(){let r,e;try{e=process}catch{}const s=e&&e.env?e.env.devicePixelRatio:null;return s&&(r=parseInt(s,10),Number.isNaN(r)&&(r=1)),r||window.devicePixelRatio||1}const v=16384;function zt(r){(r.width>v||r.height>v)&&(r.width>v&&r.height>v?r.width>r.height?(r.height*=v/r.width,r.width=v):(r.width*=v/r.height,r.height=v):r.width>v?(r.height*=v/r.width,r.width=v):(r.width*=v/r.height,r.height=v))}function U(r){return new Promise((e,s)=>{const t=new Image;t.onload=()=>{t.decode().then(()=>{requestAnimationFrame(()=>e(t))})},t.onerror=s,t.crossOrigin="anonymous",t.decoding="async",t.src=r})}async function Wt(r){return Promise.resolve().then(()=>new XMLSerializer().serializeToString(r)).then(encodeURIComponent).then(e=>`data:image/svg+xml;charset=utf-8,${e}`)}async function Ot(r,e,s){const t="http://www.w3.org/2000/svg",o=document.createElementNS(t,"svg"),a=document.createElementNS(t,"foreignObject");return o.setAttribute("width",`${e}`),o.setAttribute("height",`${s}`),o.setAttribute("viewBox",`0 0 ${e} ${s}`),a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("externalResourcesRequired","true"),o.appendChild(a),a.appendChild(r),Wt(o)}const E=(r,e)=>{if(r instanceof e)return!0;const s=Object.getPrototypeOf(r);return s===null?!1:s.constructor.name===e.name||E(s,e)};function Vt(r){const e=r.getPropertyValue("content");return`${r.cssText} content: '${e.replace(/'|"/g,"")}';`}function Ht(r,e){return Pe(e).map(s=>{const t=r.getPropertyValue(s),o=r.getPropertyPriority(s);return`${s}: ${t}${o?" !important":""};`}).join(" ")}function Gt(r,e,s,t){const o=`.${r}:${e}`,a=s.cssText?Vt(s):Ht(s,t);return document.createTextNode(`${o}{${a}}`)}function le(r,e,s,t){const o=window.getComputedStyle(r,s),a=o.getPropertyValue("content");if(a===""||a==="none")return;const n=At();try{e.className=`${e.className} ${n}`}catch{return}const i=document.createElement("style");i.appendChild(Gt(n,s,o,t)),e.appendChild(i)}function qt(r,e,s){le(r,e,":before",s),le(r,e,":after",s)}const de="application/font-woff",ue="image/jpeg",Jt={woff:de,woff2:de,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:ue,jpeg:ue,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml",webp:"image/webp"};function Xt(r){const e=/\.([^./]*?)$/g.exec(r);return e?e[1]:""}function Y(r){const e=Xt(r).toLowerCase();return Jt[e]||""}function Yt(r){return r.split(/,/)[1]}function J(r){return r.search(/^(data:)/)!==-1}function Kt(r,e){return`data:${e};base64,${r}`}async function Ne(r,e,s){const t=await fetch(r,e);if(t.status===404)throw new Error(`Resource "${t.url}" not found`);const o=await t.blob();return new Promise((a,n)=>{const i=new FileReader;i.onerror=n,i.onloadend=()=>{try{a(s({res:t,result:i.result}))}catch(c){n(c)}},i.readAsDataURL(o)})}const G={};function Zt(r,e,s){let t=r.replace(/\?.*/,"");return s&&(t=r),/ttf|otf|eot|woff2?/i.test(t)&&(t=t.replace(/.*\//,"")),e?`[${e}]${t}`:t}async function K(r,e,s){const t=Zt(r,e,s.includeQueryParams);if(G[t]!=null)return G[t];s.cacheBust&&(r+=(/\?/.test(r)?"&":"?")+new Date().getTime());let o;try{const a=await Ne(r,s.fetchRequestInit,({res:n,result:i})=>(e||(e=n.headers.get("Content-Type")||""),Yt(i)));o=Kt(a,e)}catch(a){o=s.imagePlaceholder||"";let n=`Failed to fetch resource: ${r}`;a&&(n=typeof a=="string"?a:a.message),n&&console.warn(n)}return G[t]=o,o}async function Qt(r){const e=r.toDataURL();return e==="data:,"?r.cloneNode(!1):U(e)}async function er(r,e){if(r.currentSrc){const a=document.createElement("canvas"),n=a.getContext("2d");a.width=r.clientWidth,a.height=r.clientHeight,n==null||n.drawImage(r,0,0,a.width,a.height);const i=a.toDataURL();return U(i)}const s=r.poster,t=Y(s),o=await K(s,t,e);return U(o)}async function tr(r,e){var s;try{if(!((s=r==null?void 0:r.contentDocument)===null||s===void 0)&&s.body)return await O(r.contentDocument.body,e,!0)}catch{}return r.cloneNode(!1)}async function rr(r,e){return E(r,HTMLCanvasElement)?Qt(r):E(r,HTMLVideoElement)?er(r,e):E(r,HTMLIFrameElement)?tr(r,e):r.cloneNode($e(r))}const sr=r=>r.tagName!=null&&r.tagName.toUpperCase()==="SLOT",$e=r=>r.tagName!=null&&r.tagName.toUpperCase()==="SVG";async function nr(r,e,s){var t,o;if($e(e))return e;let a=[];return sr(r)&&r.assignedNodes?a=C(r.assignedNodes()):E(r,HTMLIFrameElement)&&(!((t=r.contentDocument)===null||t===void 0)&&t.body)?a=C(r.contentDocument.body.childNodes):a=C(((o=r.shadowRoot)!==null&&o!==void 0?o:r).childNodes),a.length===0||E(r,HTMLVideoElement)||await a.reduce((n,i)=>n.then(()=>O(i,s)).then(c=>{c&&e.appendChild(c)}),Promise.resolve()),e}function or(r,e,s){const t=e.style;if(!t)return;const o=window.getComputedStyle(r);o.cssText?(t.cssText=o.cssText,t.transformOrigin=o.transformOrigin):Pe(s).forEach(a=>{let n=o.getPropertyValue(a);a==="font-size"&&n.endsWith("px")&&(n=`${Math.floor(parseFloat(n.substring(0,n.length-2)))-.1}px`),E(r,HTMLIFrameElement)&&a==="display"&&n==="inline"&&(n="block"),a==="d"&&e.getAttribute("d")&&(n=`path(${e.getAttribute("d")})`),t.setProperty(a,n,o.getPropertyPriority(a))})}function ar(r,e){E(r,HTMLTextAreaElement)&&(e.innerHTML=r.value),E(r,HTMLInputElement)&&e.setAttribute("value",r.value)}function ir(r,e){if(E(r,HTMLSelectElement)){const t=Array.from(e.children).find(o=>r.value===o.getAttribute("value"));t&&t.setAttribute("selected","")}}function cr(r,e,s){return E(e,Element)&&(or(r,e,s),qt(r,e,s),ar(r,e),ir(r,e)),e}async function lr(r,e){const s=r.querySelectorAll?r.querySelectorAll("use"):[];if(s.length===0)return r;const t={};for(let a=0;a<s.length;a++){const i=s[a].getAttribute("xlink:href");if(i){const c=r.querySelector(i),l=document.querySelector(i);!c&&l&&!t[i]&&(t[i]=await O(l,e,!0))}}const o=Object.values(t);if(o.length){const a="http://www.w3.org/1999/xhtml",n=document.createElementNS(a,"svg");n.setAttribute("xmlns",a),n.style.position="absolute",n.style.width="0",n.style.height="0",n.style.overflow="hidden",n.style.display="none";const i=document.createElementNS(a,"defs");n.appendChild(i);for(let c=0;c<o.length;c++)i.appendChild(o[c]);r.appendChild(n)}return r}async function O(r,e,s){return!s&&e.filter&&!e.filter(r)?null:Promise.resolve(r).then(t=>rr(t,e)).then(t=>nr(r,t,e)).then(t=>cr(r,t,e)).then(t=>lr(t,e))}const Me=/url\((['"]?)([^'"]+?)\1\)/g,dr=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ur=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function pr(r){const e=r.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${e})(['"]?\\))`,"g")}function mr(r){const e=[];return r.replace(Me,(s,t,o)=>(e.push(o),s)),e.filter(s=>!J(s))}async function hr(r,e,s,t,o){try{const a=s?Bt(e,s):e,n=Y(e);let i;return o||(i=await K(a,n,t)),r.replace(pr(e),`$1${i}$3`)}catch{}return r}function fr(r,{preferredFontFormat:e}){return e?r.replace(ur,s=>{for(;;){const[t,,o]=dr.exec(s)||[];if(!o)return"";if(o===e)return`src: ${t};`}}):r}function Be(r){return r.search(Me)!==-1}async function Ae(r,e,s){if(!Be(r))return r;const t=fr(r,s);return mr(t).reduce((a,n)=>a.then(i=>hr(i,n,e,s)),Promise.resolve(t))}async function P(r,e,s){var t;const o=(t=e.style)===null||t===void 0?void 0:t.getPropertyValue(r);if(o){const a=await Ae(o,null,s);return e.style.setProperty(r,a,e.style.getPropertyPriority(r)),!0}return!1}async function gr(r,e){await P("background",r,e)||await P("background-image",r,e),await P("mask",r,e)||await P("-webkit-mask",r,e)||await P("mask-image",r,e)||await P("-webkit-mask-image",r,e)}async function yr(r,e){const s=E(r,HTMLImageElement);if(!(s&&!J(r.src))&&!(E(r,SVGImageElement)&&!J(r.href.baseVal)))return;const t=s?r.src:r.href.baseVal,o=await K(t,Y(t),e);await new Promise((a,n)=>{r.onload=a,r.onerror=e.onImageErrorHandler?(...c)=>{try{a(e.onImageErrorHandler(...c))}catch(l){n(l)}}:n;const i=r;i.decode&&(i.decode=a),i.loading==="lazy"&&(i.loading="eager"),s?(r.srcset="",r.src=o):r.href.baseVal=o})}async function wr(r,e){const t=C(r.childNodes).map(o=>_e(o,e));await Promise.all(t).then(()=>r)}async function _e(r,e){E(r,Element)&&(await gr(r,e),await yr(r,e),await wr(r,e))}function xr(r,e){const{style:s}=r;e.backgroundColor&&(s.backgroundColor=e.backgroundColor),e.width&&(s.width=`${e.width}px`),e.height&&(s.height=`${e.height}px`);const t=e.style;return t!=null&&Object.keys(t).forEach(o=>{s[o]=t[o]}),r}const pe={};async function me(r){let e=pe[r];if(e!=null)return e;const t=await(await fetch(r)).text();return e={url:r,cssText:t},pe[r]=e,e}async function he(r,e){let s=r.cssText;const t=/url\(["']?([^"')]+)["']?\)/g,a=(s.match(/url\([^)]+\)/g)||[]).map(async n=>{let i=n.replace(t,"$1");return i.startsWith("https://")||(i=new URL(i,r.url).href),Ne(i,e.fetchRequestInit,({result:c})=>(s=s.replace(n,`url(${c})`),[n,c]))});return Promise.all(a).then(()=>s)}function fe(r){if(r==null)return[];const e=[],s=/(\/\*[\s\S]*?\*\/)/gi;let t=r.replace(s,"");const o=new RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");for(;;){const c=o.exec(t);if(c===null)break;e.push(c[0])}t=t.replace(o,"");const a=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,n="((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})",i=new RegExp(n,"gi");for(;;){let c=a.exec(t);if(c===null){if(c=i.exec(t),c===null)break;a.lastIndex=i.lastIndex}else i.lastIndex=a.lastIndex;e.push(c[0])}return e}async function br(r,e){const s=[],t=[];return r.forEach(o=>{if("cssRules"in o)try{C(o.cssRules||[]).forEach((a,n)=>{if(a.type===CSSRule.IMPORT_RULE){let i=n+1;const c=a.href,l=me(c).then(h=>he(h,e)).then(h=>fe(h).forEach(y=>{try{o.insertRule(y,y.startsWith("@import")?i+=1:o.cssRules.length)}catch(d){console.error("Error inserting rule from remote css",{rule:y,error:d})}})).catch(h=>{console.error("Error loading remote css",h.toString())});t.push(l)}})}catch(a){const n=r.find(i=>i.href==null)||document.styleSheets[0];o.href!=null&&t.push(me(o.href).then(i=>he(i,e)).then(i=>fe(i).forEach(c=>{n.insertRule(c,n.cssRules.length)})).catch(i=>{console.error("Error loading remote stylesheet",i)})),console.error("Error inlining remote css file",a)}}),Promise.all(t).then(()=>(r.forEach(o=>{if("cssRules"in o)try{C(o.cssRules||[]).forEach(a=>{s.push(a)})}catch(a){console.error(`Error while reading CSS rules from ${o.href}`,a)}}),s))}function Sr(r){return r.filter(e=>e.type===CSSRule.FONT_FACE_RULE).filter(e=>Be(e.style.getPropertyValue("src")))}async function Er(r,e){if(r.ownerDocument==null)throw new Error("Provided element is not within a Document");const s=C(r.ownerDocument.styleSheets),t=await br(s,e);return Sr(t)}function je(r){return r.trim().replace(/["']/g,"")}function vr(r){const e=new Set;function s(t){(t.style.fontFamily||getComputedStyle(t).fontFamily).split(",").forEach(a=>{e.add(je(a))}),Array.from(t.children).forEach(a=>{a instanceof HTMLElement&&s(a)})}return s(r),e}async function Ir(r,e){const s=await Er(r,e),t=vr(r);return(await Promise.all(s.filter(a=>t.has(je(a.style.fontFamily))).map(a=>{const n=a.parentStyleSheet?a.parentStyleSheet.href:null;return Ae(a.cssText,n,e)}))).join(`
`)}async function Lr(r,e){const s=e.fontEmbedCSS!=null?e.fontEmbedCSS:e.skipFonts?null:await Ir(r,e);if(s){const t=document.createElement("style"),o=document.createTextNode(s);t.appendChild(o),r.firstChild?r.insertBefore(t,r.firstChild):r.appendChild(t)}}async function Ue(r,e={}){const{width:s,height:t}=Fe(r,e),o=await O(r,e,!0);return await Lr(o,e),await _e(o,e),xr(o,e),await Ot(o,s,t)}async function Cr(r,e={}){const{width:s,height:t}=Fe(r,e),o=await Ue(r,e),a=await U(o),n=document.createElement("canvas"),i=n.getContext("2d"),c=e.pixelRatio||Ut(),l=e.canvasWidth||s,h=e.canvasHeight||t;return n.width=l*c,n.height=h*c,e.skipAutoScale||zt(n),n.style.width=`${l}`,n.style.height=`${h}`,e.backgroundColor&&(i.fillStyle=e.backgroundColor,i.fillRect(0,0,n.width,n.height)),i.drawImage(a,0,0,n.width,n.height),n}async function Rr(r,e={}){return(await Cr(r,e)).toDataURL()}function ze(r){if(!r)throw new Error("Unable to export: The graph container is not available. Please reload the page and try again.");const e=r.querySelector(".react-flow");if(!e)throw new Error("Unable to locate the graph canvas for export. Please make sure the graph is visible and try again.");return e}function We(){return r=>r instanceof HTMLElement?!r.classList.contains("react-flow__controls")&&!r.classList.contains("react-flow__minimap")&&!r.classList.contains("react-flow__panel"):!0}function Oe(r,e){try{const s=document.createElement("a");s.download=e,s.href=r,s.click()}catch(s){const t=s instanceof Error?s.message:"Unknown error";throw new Error(`Failed to trigger download for "${e}": ${t}`)}}async function kr(r,e,s){try{const{backgroundColor:t="#ffffff",quality:o=1,pixelRatio:a=2,filterControls:n=!0}=s||{};console.log("[exportUtils] Exporting as PNG:",e);const i=ze(r),c=await Rr(i,{backgroundColor:t,quality:o,pixelRatio:a,filter:n?We():void 0});Oe(c,e),console.log("[exportUtils] PNG export successful")}catch(t){const o=t instanceof Error?t.message:"Unknown error during PNG export";throw console.error("[exportUtils] PNG export failed:",o),new Error(`Failed to export graph as PNG: ${o}`)}}async function Dr(r,e,s){try{const{backgroundColor:t="#ffffff",filterControls:o=!0}=s||{};console.log("[exportUtils] Exporting as SVG:",e);const a=ze(r),n=await Ue(a,{backgroundColor:t,filter:o?We():void 0});Oe(n,e),console.log("[exportUtils] SVG export successful")}catch(t){const o=t instanceof Error?t.message:"Unknown error during SVG export";throw console.error("[exportUtils] SVG export failed:",o),new Error(`Failed to export graph as SVG: ${o}`)}}function V(r,e){try{console.log("[exportUtils] Downloading JSON:",e);let s;try{s=JSON.stringify(r,null,2)}catch(a){const n=a instanceof Error?a.message:"Unable to serialize data";throw new Error(`Failed to serialize data to JSON: ${n}`)}const t=new Blob([s],{type:"application/json"}),o=URL.createObjectURL(t);try{const a=document.createElement("a");a.download=e,a.href=o,a.click()}finally{setTimeout(()=>URL.revokeObjectURL(o),100)}console.log("[exportUtils] JSON download successful")}catch(s){const t=s instanceof Error?s.message:"Unknown error during JSON download";throw console.error("[exportUtils] JSON download failed:",t),new Error(`Failed to download JSON as "${e}": ${t}`)}}function Tr(r,e){return{impactedProcesses:new Set,impactedEdges:new Set,impactPaths:[],summary:{directImpact:0,indirectImpact:0,totalImpact:0,maxPathLength:0},toJSON(){return{impactedProcesses:[],impactedEdges:[],impactPaths:[],summary:this.summary}}}}async function Pr(r,e="business-layer.png"){try{console.log("[BusinessExportService] Exporting as PNG:",e),await kr(r,e,{backgroundColor:"#ffffff",quality:1,pixelRatio:2})}catch(s){const t=s instanceof Error?s.message:"Unknown error during PNG export";throw console.error("[BusinessExportService] PNG export failed:",t),s}}async function Fr(r,e="business-layer.svg"){try{console.log("[BusinessExportService] Exporting as SVG:",e),await Dr(r,e,{backgroundColor:"#ffffff"})}catch(s){const t=s instanceof Error?s.message:"Unknown error during SVG export";throw console.error("[BusinessExportService] SVG export failed:",t),s}}function Nr(r,e,s,t="business-graph-data.json"){var o,a,n,i;try{console.log("[BusinessExportService] Exporting graph data as JSON:",t);const c={version:"0.1.0",generated:new Date().toISOString(),metadata:{nodeCount:r.length,edgeCount:e.length,layers:{functions:((o=s.indices.byType.get("function"))==null?void 0:o.size)||0,processes:((a=s.indices.byType.get("process"))==null?void 0:a.size)||0,services:((n=s.indices.byType.get("service"))==null?void 0:n.size)||0,capabilities:((i=s.indices.byType.get("capability"))==null?void 0:i.size)||0},metrics:{totalNodes:s.metrics.nodeCount,totalEdges:s.metrics.edgeCount,averageConnectivity:s.metrics.averageConnectivity,maxHierarchyDepth:s.metrics.maxHierarchyDepth,circularDependencyCount:s.metrics.circularDependencies.length,orphanedNodeCount:s.metrics.orphanedNodes.length}},nodes:r.map(l=>({id:l.id,type:l.type,position:l.position,data:l.data})),edges:e.map(l=>({id:l.id,source:l.source,target:l.target,type:l.type,label:l.label}))};V(c,t),console.log("[BusinessExportService] Graph data export successful")}catch(c){console.error("[BusinessExportService] Graph data export failed:",c);const l=c instanceof Error?c.message:"An unknown error occurred";throw new Error(`Unable to export graph data: ${l}`)}}function $r(r,e="business-catalog.json"){try{console.log("[BusinessExportService] Exporting process catalog:",e);const s={generated:new Date().toISOString(),processCount:r.nodes.size,processes:Array.from(r.nodes.values()).map(t=>({id:t.id,name:t.name,type:t.type,description:t.description,owner:t.metadata.owner,criticality:t.metadata.criticality,lifecycle:t.metadata.lifecycle,domain:t.metadata.domain,subprocessCount:t.metadata.subprocessCount,relationships:{upstream:Array.from(r.edges.values()).filter(o=>o.target===t.id).map(o=>({type:o.type,process:o.source})),downstream:Array.from(r.edges.values()).filter(o=>o.source===t.id).map(o=>({type:o.type,process:o.target}))}}))};V(s,e),console.log("[BusinessExportService] Process catalog export successful")}catch(s){console.error("[BusinessExportService] Process catalog export failed:",s);const t=s instanceof Error?s.message:"An unknown error occurred";throw new Error(`Unable to export process catalog: ${t}`)}}function Mr(r,e,s="traceability-report.json"){try{console.log("[BusinessExportService] Generating traceability report");const t=new Set,o=new Set,a=new Set;e.forEach(u=>{u.targetLayer==="motivation"&&t.add(u.source),u.targetLayer==="application"&&o.add(u.source),u.targetLayer==="data_model"&&a.add(u.source)});const n=Array.from(r.nodes.values()).filter(u=>u.type==="process"&&!o.has(u.id)).map(u=>({id:u.id,name:u.name})),i=Array.from(r.nodes.values()).map(u=>({process:{id:u.id,name:u.name,type:u.type},realizesGoals:e.filter(m=>m.source===u.id&&m.targetLayer==="motivation").map(m=>({id:m.target,type:m.type})),realizedByComponents:e.filter(m=>m.source===u.id&&m.targetLayer==="application").map(m=>({id:m.target,type:m.type})),usesDataEntities:e.filter(m=>m.source===u.id&&m.targetLayer==="data_model").map(m=>({id:m.target,type:m.type}))})),c=r.nodes.size,l=c>0?`${(t.size/c*100).toFixed(1)}%`:"0%",h=c>0?`${(o.size/c*100).toFixed(1)}%`:"0%",y=c>0?`${(a.size/c*100).toFixed(1)}%`:"0%",d={generated:new Date().toISOString(),summary:{totalProcesses:c,processesWithMotivationLinks:t.size,processesWithApplicationRealization:o.size,processesWithDataDependencies:a.size,orphanedProcesses:n.length,coverage:{motivation:l,application:h,data:y}},traceability:i,orphanedProcesses:n};console.log("[BusinessExportService] Traceability report generated:",{totalProcesses:c,processesWithMotivation:t.size,processesWithApplication:o.size,processesWithData:a.size,orphanedProcesses:n.length,coverages:d.summary.coverage}),V(d,s),console.log("[BusinessExportService] Traceability report exported successfully")}catch(t){console.error("[BusinessExportService] Traceability report export failed:",t);const o=t instanceof Error?t.message:"An unknown error occurred";throw new Error(`Unable to generate traceability report: ${o}`)}}function Br(r,e,s="impact-analysis.json"){try{if(console.log("[BusinessExportService] Generating impact analysis report"),r.size===0)throw new Error("No processes selected for impact analysis. Please select at least one process.");const t=Array.from(r).map(n=>e.nodes.get(n)).filter(n=>n!==void 0),o=Tr(t,e),a={generated:new Date().toISOString(),changedProcesses:Array.from(r).map(n=>{const i=e.nodes.get(n);return{id:n,name:i==null?void 0:i.name}}),impact:o.summary,impactedProcesses:Array.from(o.impactedProcesses).map(n=>{const i=e.nodes.get(n);return{id:n,name:i==null?void 0:i.name,type:i==null?void 0:i.type}}),impactPaths:o.impactPaths.map(n=>({path:n.path.map(i=>{const c=e.nodes.get(i);return(c==null?void 0:c.name)||i}),length:n.length}))};console.log("[BusinessExportService] Impact analysis report generated:",{changedProcesses:r.size,totalImpact:o.summary.totalImpact,directImpact:o.summary.directImpact,indirectImpact:o.summary.indirectImpact,maxPathLength:o.summary.maxPathLength}),V(a,s),console.log("[BusinessExportService] Impact analysis report exported successfully")}catch(t){console.error("[BusinessExportService] Impact analysis report export failed:",t);const o=t instanceof Error?t.message:"An unknown error occurred";throw new Error(`Unable to generate impact analysis report: ${o}`)}}const N=({model:r})=>{const[e,s]=w.useState(null),[t,o,a]=ct([]),[n,i,c]=lt([]),[l,h]=w.useState(!0),[y,d]=w.useState(null),[u,m]=w.useState(!1),[x,$]=w.useState(new Set),F=w.useRef(null),{filters:Ve,focusMode:R,focusRadius:He,setFocusMode:I,setSelectedNodeId:D,expandedNodes:Z,toggleNodeExpanded:Q}=St(),{filteredNodes:ee,filteredEdges:te,visibleCount:Ge,totalCount:qe}=Et(t,n,Ve,e),{focusedNodes:re,focusedEdges:H,dimmedNodes:se}=Nt(x,R,He,e),Je=w.useMemo(()=>{if(x.size!==1||!e)return null;const f=Array.from(x)[0];return e.nodes.get(f)||null},[x,e]);w.useEffect(()=>{try{h(!0),d(null);const g=new kt().parseBusinessLayer(r);let S=new Dt().buildGraph(g.elements,g.relationships);S=new Tt().resolveAllLinks(S,r),new ke().precalculateDimensions(S.nodes),s(S)}catch(f){const g=f instanceof Error?f.message:String(f);console.error("[BusinessLayerView] Error parsing business layer:",f),d(g)}finally{h(!1)}},[r]),w.useEffect(()=>{if(!e)return;let f=!1;return(async()=>{try{h(!0);const S=await new Pt().calculate(e,{...Ft,algorithm:"hierarchical",direction:"TB",animate:!0});if(f)return;if(S.metadata){const{calculationTime:L,usedWorker:nt}=S.metadata;console.log(`[BusinessLayerView] Layout calculated in ${L.toFixed(2)}ms ${nt?"(Web Worker)":"(main thread)"}`)}o(S.nodes);const ne=e.crossLayerLinks.map(L=>({id:`cross-${L.source}-${L.target}`,source:L.source,target:L.target,type:"elbow",data:{targetLayer:L.targetLayer,relationshipType:L.type,label:L.type},style:{strokeDasharray:"5,5"}}));i([...S.edges,...ne])}catch(b){if(f)return;const S=b instanceof Error?b.message:String(b);console.error("[BusinessLayerView] Error calculating layout:",b),d(S)}finally{f||h(!1)}})(),()=>{f=!0}},[e,o,i]);const Xe=w.useCallback(async f=>{if(!e){d("Cannot export: business graph not loaded");return}if(!u)try{m(!0),d(null);const g=new Date().toISOString().replace(/:/g,"-").split(".")[0];switch(f){case"png":F.current&&await Pr(F.current,`business-layer-${g}.png`);break;case"svg":F.current&&await Fr(F.current,`business-layer-${g}.svg`);break;case"graphData":Nr(t,n,e,`business-graph-${g}.json`);break;case"catalog":$r(e,`business-catalog-${g}.json`);break;case"traceability":Mr(e,e.crossLayerLinks,`traceability-${g}.json`);break;case"impact":if(x.size===0){d("Please select at least one process to analyze impact");return}Br(x,e,`impact-analysis-${g}.json`);break}}catch(g){const b=g instanceof Error?g.message:String(g);console.error("[BusinessLayerView] Export failed:",g),d(`Export failed: ${b}`)}finally{m(!1)}},[t,n,e,x,u]),Ye=w.useCallback((f,g)=>{f.shiftKey?$(b=>{const S=new Set(b);return S.add(g.id),S}):($(new Set([g.id])),D(g.id),I("selected"))},[I,D]),Ke=w.useCallback((f,g)=>{$(new Set([g.id])),D(g.id)},[D]),Ze=w.useCallback(()=>{I("upstream")},[I]),Qe=w.useCallback(()=>{I("downstream")},[I]),et=w.useCallback(()=>{I("radial")},[I]),tt=w.useCallback((f,g)=>{window.dispatchEvent(new CustomEvent("navigate-to-layer",{detail:{layer:f,elementId:g}}))},[]),rt=w.useMemo(()=>ee.map(f=>{const g=R!=="none"&&re.has(f.id),b=R!=="none"&&se.has(f.id);return{...f,data:{...f.data,expandedNodes:Z,onToggleExpanded:Q},style:{...f.style,opacity:b?.3:1,boxShadow:g?"0 0 0 3px rgba(74, 144, 226, 0.5)":void 0},className:g?"border-[3px] border-blue-400":void 0}}),[ee,re,se,R,Z,Q]),st=w.useMemo(()=>te.map(f=>{const g=R!=="none"&&H.has(f.id),b=R!=="none"&&!H.has(f.id);return{...f,style:{...f.style,opacity:b?.2:1,strokeWidth:g?3:2}}}),[te,H,R]);return w.useEffect(()=>{const f=g=>{g.key==="Escape"&&($(new Set),D(void 0),I("none"))};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[I,D]),y?p.jsx("div",{className:"w-full h-screen flex items-center justify-center font-sans",children:p.jsxs("div",{className:"p-6 bg-red-50 border-2 border-red-800 rounded-lg max-w-xl",children:[p.jsx("h2",{className:"m-0 mb-3 text-red-800 font-bold",children:"Error"}),p.jsx("p",{className:"m-0 text-gray-700",children:y})]})}):l?p.jsx("div",{className:"w-full h-screen flex items-center justify-center font-sans",children:p.jsx("div",{className:"p-6 bg-blue-50 border-2 border-blue-700 rounded-lg",children:p.jsx("p",{className:"m-0 text-blue-700 font-semibold",children:"Loading business layer..."})})}):p.jsxs("div",{className:"w-full h-screen flex flex-col",children:[p.jsx(vt,{businessGraph:e,onExport:Xe,isExporting:u,visibleCount:Ge,totalCount:qe}),p.jsxs("div",{ref:F,className:"flex-1 relative",children:[p.jsxs(dt,{nodes:rt,edges:st,nodeTypes:bt,edgeTypes:xt,onNodesChange:a,onEdgesChange:c,onNodeClick:Ye,onNodeDoubleClick:Ke,onlyRenderVisibleElements:!0,fitView:!0,fitViewOptions:{padding:.2,includeHiddenNodes:!1,duration:200},minZoom:.1,maxZoom:2,defaultEdgeOptions:{type:"elbow",animated:!1},children:[p.jsx(ut,{color:"#aaa",gap:16}),p.jsx(pt,{}),p.jsx(oe,{position:"bottom-right",className:"m-4",children:p.jsxs("div",{className:`bg-white dark:bg-gray-800 rounded-lg border border-gray-200
                       dark:border-gray-700 shadow-sm overflow-hidden`,"data-testid":"overview-panel",children:[p.jsx("div",{className:`px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400
                         border-b border-gray-200 dark:border-gray-700 bg-gray-50
                         dark:bg-gray-900`,children:"Overview"}),p.jsx("div",{className:"p-2",children:p.jsx(Lt,{nodeColor:()=>Ct("Business","primary")})})]})}),p.jsx(oe,{position:"top-left",children:p.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-md font-sans",children:[p.jsx("h3",{className:"m-0 mb-2 text-base text-gray-800",children:"Business Layer"}),e&&p.jsxs("div",{className:"text-xs text-gray-500",children:[p.jsxs("div",{children:[e.nodes.size," elements • ",e.edges.size," relationships"]}),p.jsxs("div",{children:["Max depth: ",e.hierarchy.maxDepth]}),e.metrics.circularDependencies.length>0&&p.jsxs("div",{className:"text-red-700 mt-1",children:["⚠️ ",e.metrics.circularDependencies.length," circular dependencies"]})]})]})})]}),p.jsx(It,{selectedNode:Je,businessGraph:e,onTraceUpstream:Ze,onTraceDownstream:Qe,onIsolate:et,onNavigateToCrossLayer:tt})]})]})};N.__docgenInfo={description:"BusinessLayerView - Visualize business layer with hierarchical layout",methods:[],displayName:"BusinessLayerView"};const zs={title:"C Graphs / Views / BusinessLayerView",parameters:{layout:"fullscreen"}},M={render:()=>{const r=X();return p.jsx(z,{children:p.jsx(W,{testId:"business-layer-default",children:p.jsx("div",{style:{width:"100%",height:"100vh"},children:p.jsx(N,{model:r})})})})}},B={render:()=>{const r=Rt();return p.jsx(z,{children:p.jsx(W,{testId:"business-layer-minimal",children:p.jsx("div",{style:{width:"100%",height:"100vh"},children:p.jsx(N,{model:r})})})})}},A={render:()=>{const r=X();return p.jsx(z,{children:p.jsx(W,{testId:"business-layer-large",children:p.jsx("div",{style:{width:"100%",height:"100vh"},children:p.jsx(N,{model:r})})})})}},_={render:()=>{const r=X();return p.jsx(z,{children:p.jsx(W,{testId:"business-layer-controls",children:p.jsx("div",{style:{width:"100%",height:"100vh"},children:p.jsx(N,{model:r})})})})}};var ge,ye,we;M.parameters={...M.parameters,docs:{...(ge=M.parameters)==null?void 0:ge.docs,source:{originalSource:`{
  render: () => {
    const model = createCompleteModelFixture();
    return <ReactFlowProvider>
        <StoryLoadedWrapper testId="business-layer-default">
          <div style={{
          width: '100%',
          height: '100vh'
        }}>
            <BusinessLayerView model={model} />
          </div>
        </StoryLoadedWrapper>
      </ReactFlowProvider>;
  }
}`,...(we=(ye=M.parameters)==null?void 0:ye.docs)==null?void 0:we.source}}};var xe,be,Se;B.parameters={...B.parameters,docs:{...(xe=B.parameters)==null?void 0:xe.docs,source:{originalSource:`{
  render: () => {
    const model = createMinimalModelFixture();
    return <ReactFlowProvider>
        <StoryLoadedWrapper testId="business-layer-minimal">
          <div style={{
          width: '100%',
          height: '100vh'
        }}>
            <BusinessLayerView model={model} />
          </div>
        </StoryLoadedWrapper>
      </ReactFlowProvider>;
  }
}`,...(Se=(be=B.parameters)==null?void 0:be.docs)==null?void 0:Se.source}}};var Ee,ve,Ie;A.parameters={...A.parameters,docs:{...(Ee=A.parameters)==null?void 0:Ee.docs,source:{originalSource:`{
  render: () => {
    const model = createCompleteModelFixture();
    return <ReactFlowProvider>
        <StoryLoadedWrapper testId="business-layer-large">
          <div style={{
          width: '100%',
          height: '100vh'
        }}>
            <BusinessLayerView model={model} />
          </div>
        </StoryLoadedWrapper>
      </ReactFlowProvider>;
  }
}`,...(Ie=(ve=A.parameters)==null?void 0:ve.docs)==null?void 0:Ie.source}}};var Le,Ce,Re;_.parameters={..._.parameters,docs:{...(Le=_.parameters)==null?void 0:Le.docs,source:{originalSource:`{
  render: () => {
    const model = createCompleteModelFixture();
    return <ReactFlowProvider>
        <StoryLoadedWrapper testId="business-layer-controls">
          <div style={{
          width: '100%',
          height: '100vh'
        }}>
            <BusinessLayerView model={model} />
          </div>
        </StoryLoadedWrapper>
      </ReactFlowProvider>;
  }
}`,...(Re=(Ce=_.parameters)==null?void 0:Ce.docs)==null?void 0:Re.source}}};const Ws=["Default","MinimalGraph","LargeGraph","WithControls"];export{M as Default,A as LargeGraph,B as MinimalGraph,_ as WithControls,Ws as __namedExportsOrder,zs as default};
